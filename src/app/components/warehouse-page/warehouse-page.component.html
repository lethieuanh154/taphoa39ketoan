<div class="warehouse-page">
  <!-- HEADER -->
  <div class="page-header">
    <div>
      <h1 class="page-title">{{ pageTitle }}</h1>
      <p class="page-subtitle">{{ pageSubtitle }}</p>
    </div>
    <button class="btn btn-primary" (click)="openCreateModal()">
      <span class="icon">+</span>
      {{ voucherType === 'RECEIPT' ? 'T·∫°o phi·∫øu nh·∫≠p' : 'T·∫°o phi·∫øu xu·∫•t' }}
    </button>
  </div>

  <!-- STATS CARDS -->
  <div class="stats-cards">
    <div class="stat-card card-total">
      <span class="stat-icon">üì¶</span>
      <div class="stat-content">
        <span class="stat-label">T·ªïng phi·∫øu</span>
        <span class="stat-value">{{ summary.totalVouchers }}</span>
      </div>
    </div>
    <div class="stat-card card-draft">
      <span class="stat-icon">üìù</span>
      <div class="stat-content">
        <span class="stat-label">Nh√°p</span>
        <span class="stat-value">{{ summary.draftCount }}</span>
      </div>
    </div>
    <div class="stat-card card-posted">
      <span class="stat-icon">‚úÖ</span>
      <div class="stat-content">
        <span class="stat-label">ƒê√£ ghi s·ªï</span>
        <span class="stat-value">{{ summary.postedCount }}</span>
      </div>
    </div>
    <div class="stat-card card-quantity">
      <span class="stat-icon">üìä</span>
      <div class="stat-content">
        <span class="stat-label">T·ªïng SL</span>
        <span class="stat-value">{{ formatCurrency(summary.totalQuantity) }}</span>
      </div>
    </div>
    <div class="stat-card card-amount">
      <span class="stat-icon">üí∞</span>
      <div class="stat-content">
        <span class="stat-label">T·ªïng gi√° tr·ªã</span>
        <span class="stat-value">{{ formatCurrency(summary.totalAmount) }}</span>
      </div>
    </div>
  </div>

  <!-- FILTERS -->
  <div class="filter-section">
    <div class="filter-row">
      <div class="filter-group filter-search">
        <label>T√¨m ki·∫øm</label>
        <input type="text" [(ngModel)]="searchText" (input)="onSearch()"
               placeholder="S·ªë phi·∫øu, ƒë·ªëi t√°c, m√£ h√†ng...">
      </div>
      <div class="filter-group">
        <label>Tr·∫°ng th√°i</label>
        <select [(ngModel)]="statusFilter" (change)="onStatusFilterChange()">
          <option value="">T·∫•t c·∫£</option>
          <option value="DRAFT">Nh√°p</option>
          <option value="POSTED">ƒê√£ ghi s·ªï</option>
          <option value="CANCELLED">ƒê√£ h·ªßy</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Kho</label>
        <select [(ngModel)]="filter.warehouseCode" (change)="applyFilter()">
          <option value="">T·∫•t c·∫£ kho</option>
          <option *ngFor="let wh of warehouses" [value]="wh.code">{{ wh.name }}</option>
        </select>
      </div>
      <button class="btn btn-secondary btn-sm" (click)="clearFilters()">X√≥a l·ªçc</button>
    </div>
  </div>

  <!-- DATA TABLE -->
  <div class="table-container">
    <table class="data-table">
      <thead>
        <tr>
          <th class="col-no">STT</th>
          <th class="col-voucher-no">S·ªë phi·∫øu</th>
          <th class="col-date">Ng√†y</th>
          <th class="col-type">Lo·∫°i</th>
          <th class="col-partner">ƒê·ªëi t√°c</th>
          <th class="col-warehouse">Kho</th>
          <th class="col-quantity text-right">S·ªë l∆∞·ª£ng</th>
          <th class="col-amount text-right">Gi√° tr·ªã</th>
          <th class="col-status">Tr·∫°ng th√°i</th>
          <th class="col-actions">Thao t√°c</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let voucher of filteredVouchers; let i = index"
            [class.cancelled]="voucher.status === 'CANCELLED'">
          <td>{{ i + 1 }}</td>
          <td>
            <span class="voucher-no">{{ voucher.voucherNo }}</span>
          </td>
          <td>{{ formatDate(voucher.voucherDate) }}</td>
          <td>
            <span class="type-badge" [class.type-receipt]="voucherType === 'RECEIPT'"
                  [class.type-issue]="voucherType === 'ISSUE'">
              {{ getSubTypeLabel(voucher) }}
            </span>
          </td>
          <td>
            <div class="partner-info">
              <span class="partner-name">{{ voucher.partnerName || '-' }}</span>
              <span class="partner-code" *ngIf="voucher.partnerCode">{{ voucher.partnerCode }}</span>
            </div>
          </td>
          <td>{{ voucher.warehouseName }}</td>
          <td class="text-right">{{ formatCurrency(voucher.totalQuantity) }}</td>
          <td class="text-right">{{ formatCurrency(voucher.totalAmount) }}</td>
          <td>
            <span class="status-badge" [ngClass]="getStatusClass(voucher.status)">
              {{ statusLabels[voucher.status] }}
            </span>
          </td>
          <td>
            <div class="action-buttons">
              <button class="btn-icon btn-view" title="Xem chi ti·∫øt" (click)="viewDetail(voucher)">üëÅ</button>
              <button class="btn-icon btn-journal" title="Xem b√∫t to√°n" (click)="viewJournal(voucher)"
                      *ngIf="voucher.status === 'POSTED'">üìí</button>
              <button class="btn-icon btn-edit" title="S·ª≠a" (click)="openEditModal(voucher)"
                      *ngIf="voucher.status === 'DRAFT'">‚úèÔ∏è</button>
              <button class="btn-icon btn-delete" title="X√≥a" (click)="deleteVoucher(voucher)"
                      *ngIf="voucher.status === 'DRAFT'">üóë</button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Empty State -->
    <div class="empty-state" *ngIf="filteredVouchers.length === 0 && !isLoading">
      <div class="empty-icon">üì¶</div>
      <p>Ch∆∞a c√≥ phi·∫øu {{ voucherType === 'RECEIPT' ? 'nh·∫≠p' : 'xu·∫•t' }} kho n√†o</p>
      <p class="empty-text">Nh·∫•n n√∫t "T·∫°o phi·∫øu" ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
    </div>
  </div>

  <!-- CREATE/EDIT MODAL -->
  <div class="modal-overlay" *ngIf="showCreateModal" (click)="closeCreateModal()">
    <div class="modal modal-large" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ editingVoucher.id ? 'S·ª≠a' : 'T·∫°o' }} {{ voucherType === 'RECEIPT' ? 'Phi·∫øu Nh·∫≠p Kho' : 'Phi·∫øu Xu·∫•t Kho' }}</h2>
        <button class="btn-close" (click)="closeCreateModal()">√ó</button>
      </div>

      <div class="modal-body">
        <!-- Basic Info -->
        <div class="form-section">
          <h3 class="section-title">Th√¥ng tin chung</h3>
          <div class="form-grid">
            <div class="form-group">
              <label>S·ªë phi·∫øu</label>
              <input type="text" [(ngModel)]="editingVoucher.voucherNo" disabled>
            </div>
            <div class="form-group">
              <label>Ng√†y phi·∫øu <span class="required">*</span></label>
              <input type="date" [ngModel]="editingVoucher.voucherDate | date:'yyyy-MM-dd'"
                     (ngModelChange)="onVoucherDateChange($event)">
            </div>
            <div class="form-group">
              <label>Lo·∫°i {{ voucherType === 'RECEIPT' ? 'nh·∫≠p' : 'xu·∫•t' }} <span class="required">*</span></label>
              <select *ngIf="voucherType === 'RECEIPT'" [(ngModel)]="editingVoucher.receiptType"
                      (change)="onReceiptTypeChange()">
                <option *ngFor="let type of receiptTypes" [value]="type">{{ receiptTypeLabels[type] }}</option>
              </select>
              <select *ngIf="voucherType === 'ISSUE'" [(ngModel)]="editingVoucher.issueType"
                      (change)="onIssueTypeChange()">
                <option *ngFor="let type of issueTypes" [value]="type">{{ issueTypeLabels[type] }}</option>
              </select>
            </div>
            <div class="form-group">
              <label>Kho <span class="required">*</span></label>
              <select [(ngModel)]="editingVoucher.warehouseCode" (change)="onWarehouseChange()">
                <option value="">-- Ch·ªçn kho --</option>
                <option *ngFor="let wh of warehouses" [value]="wh.code">{{ wh.name }}</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Partner Info -->
        <div class="form-section">
          <h3 class="section-title">{{ voucherType === 'RECEIPT' ? 'Nh√† cung c·∫•p' : 'Kh√°ch h√†ng' }}</h3>
          <div class="form-grid">
            <div class="form-group col-span-2">
              <label>{{ voucherType === 'RECEIPT' ? 'Nh√† cung c·∫•p' : 'Kh√°ch h√†ng' }}</label>
              <select [(ngModel)]="editingVoucher.partnerId" (change)="onPartnerChange()">
                <option value="">-- Ch·ªçn ƒë·ªëi t√°c --</option>
                <option *ngFor="let p of partners" [value]="p.id">{{ p.code }} - {{ p.name }}</option>
              </select>
            </div>
            <div class="form-group">
              <label>Th·ªß kho</label>
              <input type="text" [(ngModel)]="editingVoucher.keeper">
            </div>
            <div class="form-group">
              <label>Ng∆∞·ªùi {{ voucherType === 'RECEIPT' ? 'giao' : 'nh·∫≠n' }}</label>
              <input type="text" [(ngModel)]="editingVoucher.receiver">
            </div>
          </div>
        </div>

        <!-- Reference Voucher -->
        <div class="form-section">
          <h3 class="section-title">Ch·ª©ng t·ª´ g·ªëc</h3>
          <div class="form-grid">
            <div class="form-group">
              <label>S·ªë ch·ª©ng t·ª´ g·ªëc</label>
              <input type="text" [(ngModel)]="editingVoucher.refVoucherNo" placeholder="S·ªë Hƒê, ƒêH...">
            </div>
            <div class="form-group">
              <label>Ng√†y CT g·ªëc</label>
              <input type="date" [ngModel]="editingVoucher.refVoucherDate | date:'yyyy-MM-dd'"
                     (ngModelChange)="onRefVoucherDateChange($event)">
            </div>
            <div class="form-group col-span-2">
              <label>Di·ªÖn gi·∫£i</label>
              <input type="text" [(ngModel)]="editingVoucher.description">
            </div>
          </div>
        </div>

        <!-- Lines -->
        <div class="form-section">
          <div class="section-header">
            <h3 class="section-title">Chi ti·∫øt h√†ng h√≥a</h3>
          </div>

          <!-- Add Line Form -->
          <div class="add-line-form">
            <div class="form-grid">
              <div class="form-group col-span-2">
                <label>H√†ng h√≥a <span class="required">*</span></label>
                <select [(ngModel)]="selectedProductId" (change)="onProductSelect()">
                  <option value="">-- Ch·ªçn h√†ng h√≥a --</option>
                  <option *ngFor="let p of products" [value]="p.id">{{ p.code }} - {{ p.name }}</option>
                </select>
              </div>
              <div class="form-group">
                <label>ƒêVT</label>
                <input type="text" [(ngModel)]="newLine.unit" disabled>
              </div>
              <div class="form-group">
                <label>TK kho</label>
                <input type="text" [(ngModel)]="newLine.inventoryAccount" placeholder="156">
              </div>
              <div class="form-group">
                <label>S·ªë l∆∞·ª£ng <span class="required">*</span></label>
                <input type="number" [(ngModel)]="newLine.quantity" (input)="calculateLineAmount()" min="0">
              </div>
              <div class="form-group">
                <label>ƒê∆°n gi√°</label>
                <input type="number" [(ngModel)]="newLine.unitPrice" (input)="calculateLineAmount()" min="0">
              </div>
              <div class="form-group">
                <label>Th√†nh ti·ªÅn</label>
                <input type="text" [value]="formatCurrency(newLine.amount || 0)" disabled>
              </div>
              <div class="form-group">
                <button class="btn btn-primary btn-sm" (click)="addLineToVoucher()"
                        [disabled]="!selectedProductId || !newLine.quantity">
                  + Th√™m d√≤ng
                </button>
              </div>
            </div>
          </div>

          <!-- Lines Table -->
          <table class="lines-table" *ngIf="editingVoucher.lines && editingVoucher.lines.length > 0">
            <thead>
              <tr>
                <th class="col-no">STT</th>
                <th>M√£ h√†ng</th>
                <th>T√™n h√†ng h√≥a</th>
                <th>ƒêVT</th>
                <th>TK kho</th>
                <th class="text-right">SL</th>
                <th class="text-right">ƒê∆°n gi√°</th>
                <th class="text-right">Th√†nh ti·ªÅn</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let line of editingVoucher.lines; let i = index">
                <td>{{ line.lineNo }}</td>
                <td>{{ line.productCode }}</td>
                <td>{{ line.productName }}</td>
                <td>{{ line.unit }}</td>
                <td>{{ line.inventoryAccount }}</td>
                <td class="text-right">{{ formatCurrency(line.quantity) }}</td>
                <td class="text-right">{{ formatCurrency(line.unitPrice) }}</td>
                <td class="text-right">{{ formatCurrency(line.amount) }}</td>
                <td>
                  <button class="btn-icon btn-remove" (click)="removeLine(i)">√ó</button>
                </td>
              </tr>
            </tbody>
            <tfoot>
              <tr>
                <td colspan="5" class="text-right"><strong>T·ªïng c·ªông:</strong></td>
                <td class="text-right"><strong>{{ formatCurrency(editingVoucher.totalQuantity || 0) }}</strong></td>
                <td></td>
                <td class="text-right"><strong>{{ formatCurrency(editingVoucher.totalAmount || 0) }}</strong></td>
                <td></td>
              </tr>
            </tfoot>
          </table>

          <div class="empty-lines" *ngIf="!editingVoucher.lines || editingVoucher.lines.length === 0">
            <p>Ch∆∞a c√≥ h√†ng h√≥a. Vui l√≤ng th√™m chi ti·∫øt h√†ng h√≥a.</p>
          </div>
        </div>

        <!-- Note -->
        <div class="form-section">
          <div class="form-group">
            <label>Ghi ch√∫</label>
            <textarea [(ngModel)]="editingVoucher.note" rows="2"></textarea>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeCreateModal()">H·ªßy</button>
        <button class="btn btn-primary" (click)="saveVoucher()" [disabled]="isSaving">
          {{ isSaving ? 'ƒêang l∆∞u...' : 'L∆∞u phi·∫øu' }}
        </button>
      </div>
    </div>
  </div>

  <!-- DETAIL MODAL -->
  <div class="modal-overlay" *ngIf="showDetailModal && selectedVoucher" (click)="closeDetailModal()">
    <div class="modal modal-large" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Chi ti·∫øt {{ voucherType === 'RECEIPT' ? 'Phi·∫øu Nh·∫≠p Kho' : 'Phi·∫øu Xu·∫•t Kho' }}</h2>
        <button class="btn-close" (click)="closeDetailModal()">√ó</button>
      </div>

      <div class="modal-body">
        <div class="detail-grid">
          <div class="detail-section">
            <h4>Th√¥ng tin phi·∫øu</h4>
            <div class="detail-item">
              <label>S·ªë phi·∫øu:</label>
              <span class="voucher-no">{{ selectedVoucher.voucherNo }}</span>
            </div>
            <div class="detail-item">
              <label>Ng√†y phi·∫øu:</label>
              <span>{{ formatDate(selectedVoucher.voucherDate) }}</span>
            </div>
            <div class="detail-item">
              <label>Lo·∫°i:</label>
              <span>{{ getSubTypeLabel(selectedVoucher) }}</span>
            </div>
            <div class="detail-item">
              <label>Tr·∫°ng th√°i:</label>
              <span class="status-badge" [ngClass]="getStatusClass(selectedVoucher.status)">
                {{ statusLabels[selectedVoucher.status] }}
              </span>
            </div>
          </div>

          <div class="detail-section">
            <h4>Kho & ƒê·ªëi t√°c</h4>
            <div class="detail-item">
              <label>Kho:</label>
              <span>{{ selectedVoucher.warehouseName }}</span>
            </div>
            <div class="detail-item">
              <label>{{ voucherType === 'RECEIPT' ? 'NCC' : 'Kh√°ch h√†ng' }}:</label>
              <span>{{ selectedVoucher.partnerName || '-' }}</span>
            </div>
            <div class="detail-item">
              <label>Th·ªß kho:</label>
              <span>{{ selectedVoucher.keeper || '-' }}</span>
            </div>
            <div class="detail-item">
              <label>Ng∆∞·ªùi {{ voucherType === 'RECEIPT' ? 'giao' : 'nh·∫≠n' }}:</label>
              <span>{{ selectedVoucher.receiver || '-' }}</span>
            </div>
          </div>

          <div class="detail-section">
            <h4>T·ªïng h·ª£p</h4>
            <div class="detail-item">
              <label>T·ªïng s·ªë l∆∞·ª£ng:</label>
              <span>{{ formatCurrency(selectedVoucher.totalQuantity) }}</span>
            </div>
            <div class="detail-item">
              <label>T·ªïng gi√° tr·ªã:</label>
              <span class="amount-value">{{ formatCurrency(selectedVoucher.totalAmount) }} ‚Ç´</span>
            </div>
            <div class="detail-item">
              <label>CT g·ªëc:</label>
              <span>{{ selectedVoucher.refVoucherNo || '-' }}</span>
            </div>
          </div>
        </div>

        <!-- Lines Detail -->
        <div class="detail-list">
          <h4>Chi ti·∫øt h√†ng h√≥a</h4>
          <table class="sub-table">
            <thead>
              <tr>
                <th>STT</th>
                <th>M√£ h√†ng</th>
                <th>T√™n h√†ng h√≥a</th>
                <th>ƒêVT</th>
                <th>TK kho</th>
                <th class="text-right">S·ªë l∆∞·ª£ng</th>
                <th class="text-right">ƒê∆°n gi√°</th>
                <th class="text-right">Th√†nh ti·ªÅn</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let line of selectedVoucher.lines">
                <td>{{ line.lineNo }}</td>
                <td>{{ line.productCode }}</td>
                <td>{{ line.productName }}</td>
                <td>{{ line.unit }}</td>
                <td>{{ line.inventoryAccount }}</td>
                <td class="text-right">{{ formatCurrency(line.quantity) }}</td>
                <td class="text-right">{{ formatCurrency(line.unitPrice) }}</td>
                <td class="text-right">{{ formatCurrency(line.amount) }}</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Description -->
        <div class="detail-note" *ngIf="selectedVoucher.description">
          <h4>Di·ªÖn gi·∫£i</h4>
          <p>{{ selectedVoucher.description }}</p>
        </div>

        <!-- Cancel Info -->
        <div class="cancel-info" *ngIf="selectedVoucher.status === 'CANCELLED'">
          <h4>Th√¥ng tin h·ªßy</h4>
          <p><strong>Ng√†y h·ªßy:</strong> {{ formatDateTime(selectedVoucher.cancelledAt) }}</p>
          <p><strong>Ng∆∞·ªùi h·ªßy:</strong> {{ selectedVoucher.cancelledBy }}</p>
          <p><strong>L√Ω do:</strong> {{ selectedVoucher.cancelReason }}</p>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeDetailModal()">ƒê√≥ng</button>
        <button class="btn btn-danger" (click)="openCancelModal(selectedVoucher)"
                *ngIf="selectedVoucher.status !== 'CANCELLED'">
          H·ªßy phi·∫øu
        </button>
        <button class="btn btn-primary" (click)="postVoucher(selectedVoucher)"
                *ngIf="selectedVoucher.status === 'DRAFT'">
          Ghi s·ªï
        </button>
      </div>
    </div>
  </div>

  <!-- JOURNAL MODAL -->
  <div class="modal-overlay" *ngIf="showJournalModal && selectedVoucher" (click)="closeJournalModal()">
    <div class="modal modal-small" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>B√∫t to√°n k·∫ø to√°n</h2>
        <button class="btn-close" (click)="closeJournalModal()">√ó</button>
      </div>

      <div class="modal-body">
        <div class="journal-info">
          <p><strong>S·ªë phi·∫øu:</strong> {{ selectedVoucher.voucherNo }}</p>
          <p><strong>Ng√†y:</strong> {{ formatDate(selectedVoucher.voucherDate) }}</p>
          <p><strong>Di·ªÖn gi·∫£i:</strong> {{ selectedVoucher.description }}</p>
        </div>

        <table class="journal-table">
          <thead>
            <tr>
              <th>TK N·ª£</th>
              <th>TK C√≥</th>
              <th class="text-right">S·ªë ti·ªÅn</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><strong>{{ selectedVoucher.debitAccount }}</strong></td>
              <td><strong>{{ selectedVoucher.creditAccount }}</strong></td>
              <td class="text-right"><strong>{{ formatCurrency(selectedVoucher.totalAmount) }}</strong></td>
            </tr>
          </tbody>
        </table>

        <div class="journal-note">
          <p *ngIf="voucherType === 'RECEIPT'">
            N·ª£ TK {{ selectedVoucher.debitAccount }} (H√†ng h√≥a/NVL) / C√≥ TK {{ selectedVoucher.creditAccount }} (Ph·∫£i tr·∫£ NCC)
          </p>
          <p *ngIf="voucherType === 'ISSUE'">
            N·ª£ TK {{ selectedVoucher.debitAccount }} (Gi√° v·ªën) / C√≥ TK {{ selectedVoucher.creditAccount }} (H√†ng h√≥a)
          </p>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeJournalModal()">ƒê√≥ng</button>
      </div>
    </div>
  </div>

  <!-- CANCEL MODAL -->
  <div class="modal-overlay" *ngIf="showCancelModal" (click)="closeCancelModal()">
    <div class="modal modal-small" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>H·ªßy phi·∫øu kho</h2>
        <button class="btn-close" (click)="closeCancelModal()">√ó</button>
      </div>

      <div class="modal-body">
        <div class="warning-message">
          <span class="warning-icon">‚ö†Ô∏è</span>
          <p>B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy phi·∫øu <strong>{{ selectedVoucher?.voucherNo }}</strong>?
            Thao t√°c n√†y kh√¥ng th·ªÉ ho√†n t√°c.</p>
        </div>

        <div class="form-group" style="margin-top: 16px;">
          <label>L√Ω do h·ªßy <span class="required">*</span></label>
          <textarea [(ngModel)]="cancelReason" rows="3" placeholder="Nh·∫≠p l√Ω do h·ªßy phi·∫øu..."></textarea>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeCancelModal()">Kh√¥ng</button>
        <button class="btn btn-danger" (click)="confirmCancel()" [disabled]="!cancelReason">
          X√°c nh·∫≠n h·ªßy
        </button>
      </div>
    </div>
  </div>

  <!-- LOADING -->
  <div class="loading-overlay" *ngIf="isLoading">
    <div class="spinner"></div>
  </div>
</div>

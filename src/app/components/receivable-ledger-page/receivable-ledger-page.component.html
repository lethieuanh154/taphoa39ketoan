<div class="receivable-ledger-page">
  <!-- HEADER -->
  <div class="page-header">
    <div>
      <h1 class="page-title">S·ªï Chi Ti·∫øt TK 131</h1>
      <p class="page-subtitle">C√¥ng n·ª£ ph·∫£i thu kh√°ch h√†ng</p>
    </div>
    <div class="header-actions">
      <button class="btn btn-secondary" (click)="loadData()"><span class="icon">üîÑ</span> T·∫£i l·∫°i</button>
      <button class="btn btn-secondary" (click)="print()"><span class="icon">üñ®</span> In</button>
      <button class="btn btn-primary" (click)="exportToExcel()"><span class="icon">üì•</span> Xu·∫•t Excel</button>
    </div>
  </div>

  <!-- ERROR MESSAGE -->
  @if (errorMessage()) {
    <div class="error-banner">
      <span>‚ö†Ô∏è {{ errorMessage() }}</span>
      <button class="btn-close" (click)="errorMessage.set(null)">√ó</button>
    </div>
  }

  <!-- SUMMARY CARDS -->
  <div class="summary-cards">
    <div class="summary-card card-customers">
      <div class="card-icon">üë•</div>
      <div class="card-content">
        <span class="card-label">Kh√°ch h√†ng</span>
        <span class="card-value">{{ summary().totalCustomers }}</span>
      </div>
    </div>
    <div class="summary-card card-opening">
      <div class="card-icon">üìã</div>
      <div class="card-content">
        <span class="card-label">D∆∞ ƒë·∫ßu k·ª≥</span>
        <span class="card-value">{{ formatCurrency(summary().totalOpeningBalance) }}</span>
      </div>
    </div>
    <div class="summary-card card-debit">
      <div class="card-icon">üìà</div>
      <div class="card-content">
        <span class="card-label">PS N·ª£ (B√°n)</span>
        <span class="card-value text-blue">{{ formatCurrency(summary().totalDebit) }}</span>
      </div>
    </div>
    <div class="summary-card card-credit">
      <div class="card-icon">üìâ</div>
      <div class="card-content">
        <span class="card-label">PS C√≥ (Thu)</span>
        <span class="card-value text-green">{{ formatCurrency(summary().totalCredit) }}</span>
      </div>
    </div>
    <div class="summary-card card-closing-debit">
      <div class="card-icon">üí∞</div>
      <div class="card-content">
        <span class="card-label">D∆∞ N·ª£ cu·ªëi k·ª≥</span>
        <span class="card-value text-blue">{{ formatCurrency(getDebitBalance(summary().totalClosingBalance)) }}</span>
      </div>
    </div>
    <div class="summary-card card-closing-credit">
      <div class="card-icon">üí≥</div>
      <div class="card-content">
        <span class="card-label">D∆∞ C√≥ cu·ªëi k·ª≥</span>
        <span class="card-value text-green">{{ formatCurrency(getCreditBalance(summary().totalClosingBalance)) }}</span>
      </div>
    </div>
  </div>

  <!-- FILTER SECTION -->
  <div class="filter-section">
    <div class="filter-row">
      <div class="filter-group filter-customer">
        <label>Kh√°ch h√†ng</label>
        <select [ngModel]="selectedCustomerId()" (ngModelChange)="selectedCustomerId.set($event); onCustomerChange()">
          <option value="">-- T·∫•t c·∫£ kh√°ch h√†ng --</option>
          @for (c of customers(); track c.id) {
            <option [value]="c.id">{{ c.code || c.name }} - {{ c.name }}</option>
          }
        </select>
      </div>
      <div class="filter-group">
        <label>T·ª´ ng√†y</label>
        <input type="date" [value]="formatDateForInput(fromDate())" (change)="onFromDateChange($any($event.target).value)">
      </div>
      <div class="filter-group">
        <label>ƒê·∫øn ng√†y</label>
        <input type="date" [value]="formatDateForInput(toDate())" (change)="onToDateChange($any($event.target).value)">
      </div>
      <div class="filter-group">
        <div class="date-shortcuts">
          <button class="btn-chip" (click)="setDateRange('thisMonth')">Th√°ng n√†y</button>
          <button class="btn-chip" (click)="setDateRange('lastMonth')">Th√°ng tr∆∞·ªõc</button>
          <button class="btn-chip" (click)="setDateRange('thisQuarter')">Qu√Ω n√†y</button>
          <button class="btn-chip" (click)="setDateRange('thisYear')">NƒÉm nay</button>
        </div>
      </div>
    </div>
  </div>

  <!-- VIEW TABS -->
  <div class="view-tabs">
    <button class="tab-btn" [class.active]="viewMode() === 'summary'" (click)="showSummary()">T·ªïng h·ª£p</button>
    <button class="tab-btn" [class.active]="viewMode() === 'detail'" [disabled]="!selectedCustomerId()">Chi ti·∫øt</button>
  </div>

  <!-- SUMMARY VIEW -->
  @if (viewMode() === 'summary') {
    <div class="table-container">
      <div class="report-title">
        <h2>S·ªî CHI TI·∫æT T√ÄI KHO·∫¢N 131 - PH·∫¢I THU KH√ÅCH H√ÄNG</h2>
        <p>K·ª≥: {{ formatDate(fromDate()) }} - {{ formatDate(toDate()) }}</p>
      </div>

      <table class="data-table">
        <thead>
          <tr>
            <th class="col-no">STT</th>
            <th class="col-code">M√£ KH</th>
            <th class="col-name">T√™n kh√°ch h√†ng</th>
            <th class="col-amount text-right">D∆∞ ƒë·∫ßu k·ª≥</th>
            <th class="col-amount text-right">PS N·ª£</th>
            <th class="col-amount text-right">PS C√≥</th>
            <th class="col-amount text-right">D∆∞ N·ª£</th>
            <th class="col-amount text-right">D∆∞ C√≥</th>
            <th class="col-action"></th>
          </tr>
        </thead>
        <tbody>
          @for (item of customerReceivables(); track item.customerId; let i = $index) {
            <tr>
              <td>{{ i + 1 }}</td>
              <td><span class="customer-code">{{ item.customerCode || '-' }}</span></td>
              <td>{{ item.customerName }}</td>
              <td class="text-right">{{ formatCurrency(item.openingBalance) }}</td>
              <td class="text-right text-blue">{{ formatCurrency(item.totalDebit) }}</td>
              <td class="text-right text-green">{{ formatCurrency(item.totalCredit) }}</td>
              <td class="text-right text-blue">
                @if (item.closingBalance > 0) {
                  <strong>{{ formatCurrency(item.closingBalance) }}</strong>
                }
              </td>
              <td class="text-right text-green">
                @if (item.closingBalance < 0) {
                  <strong>{{ formatCurrency(-item.closingBalance) }}</strong>
                }
              </td>
              <td>
                <button class="btn-icon btn-view" title="Xem chi ti·∫øt" (click)="showDetail(item.customerId)">üëÅ</button>
              </td>
            </tr>
          }
        </tbody>
        <tfoot>
          <tr class="total-row">
            <td colspan="3"><strong>T·ªîNG C·ªòNG</strong></td>
            <td class="text-right"><strong>{{ formatCurrency(summary().totalOpeningBalance) }}</strong></td>
            <td class="text-right text-blue"><strong>{{ formatCurrency(summary().totalDebit) }}</strong></td>
            <td class="text-right text-green"><strong>{{ formatCurrency(summary().totalCredit) }}</strong></td>
            <td class="text-right text-blue"><strong>{{ formatCurrency(getDebitBalance(summary().totalClosingBalance)) }}</strong></td>
            <td class="text-right text-green"><strong>{{ formatCurrency(getCreditBalance(summary().totalClosingBalance)) }}</strong></td>
            <td></td>
          </tr>
        </tfoot>
      </table>

      @if (customerReceivables().length === 0 && !isLoading()) {
        <div class="empty-state">
          <div class="empty-icon">üìã</div>
          <p>Kh√¥ng c√≥ d·ªØ li·ªáu c√¥ng n·ª£</p>
          <p class="hint">H√£y ƒë·ªìng b·ªô h√≥a ƒë∆°n b√°n ra ho·∫∑c t·∫°o phi·∫øu thu ƒë·ªÉ xem d·ªØ li·ªáu</p>
        </div>
      }
    </div>
  }

  <!-- DETAIL VIEW -->
  @if (viewMode() === 'detail' && selectedCustomerData()) {
    <div class="table-container">
      <div class="report-title">
        <h2>S·ªî CHI TI·∫æT TK 131</h2>
        <p class="customer-info">{{ selectedCustomerData()!.customerCode || 'N/A' }} - {{ selectedCustomerData()!.customerName }}</p>
        <p>K·ª≥: {{ formatDate(fromDate()) }} - {{ formatDate(toDate()) }}</p>
      </div>

      <table class="data-table">
        <thead>
          <tr>
            <th class="col-date">Ng√†y</th>
            <th class="col-voucher">S·ªë ch·ª©ng t·ª´</th>
            <th class="col-type">Lo·∫°i</th>
            <th class="col-desc">Di·ªÖn gi·∫£i</th>
            <th class="col-amount text-right">PS N·ª£</th>
            <th class="col-amount text-right">PS C√≥</th>
            <th class="col-amount text-right">D∆∞ N·ª£</th>
            <th class="col-amount text-right">D∆∞ C√≥</th>
          </tr>
        </thead>
        <tbody>
          <!-- Opening balance -->
          <tr class="opening-row">
            <td>{{ formatDate(fromDate()) }}</td>
            <td></td>
            <td></td>
            <td><strong>D∆∞ ƒë·∫ßu k·ª≥</strong></td>
            <td class="text-right"></td>
            <td class="text-right"></td>
            <td class="text-right text-blue">
              @if (selectedCustomerData()!.openingBalance > 0) {
                <strong>{{ formatCurrency(selectedCustomerData()!.openingBalance) }}</strong>
              }
            </td>
            <td class="text-right text-green">
              @if (selectedCustomerData()!.openingBalance < 0) {
                <strong>{{ formatCurrency(-selectedCustomerData()!.openingBalance) }}</strong>
              }
            </td>
          </tr>

          <!-- Movement rows -->
          @for (line of selectedCustomerData()!.lines; track line.voucherNo) {
            <tr>
              <td>{{ formatDate(line.date) }}</td>
              <td><span class="voucher-no">{{ line.voucherNo }}</span></td>
              <td>
                <span class="type-badge" [ngClass]="'type-' + line.voucherType.toLowerCase()">
                  {{ getVoucherTypeLabel(line.voucherType) }}
                </span>
              </td>
              <td>{{ line.description }}</td>
              @if (line.debitAmount) {
                <td class="text-right text-blue">{{ formatCurrency(line.debitAmount) }}</td>
              } @else {
                <td class="text-right"></td>
              }
              @if (line.creditAmount) {
                <td class="text-right text-green">{{ formatCurrency(line.creditAmount) }}</td>
              } @else {
                <td class="text-right"></td>
              }
              <td class="text-right text-blue">
                @if (line.balance > 0) {
                  {{ formatCurrency(line.balance) }}
                }
              </td>
              <td class="text-right text-green">
                @if (line.balance < 0) {
                  {{ formatCurrency(-line.balance) }}
                }
              </td>
            </tr>
          }

          <!-- Closing balance -->
          <tr class="closing-row">
            <td>{{ formatDate(toDate()) }}</td>
            <td></td>
            <td></td>
            <td><strong>C·ªông ph√°t sinh</strong></td>
            <td class="text-right text-blue"><strong>{{ formatCurrency(selectedCustomerData()!.totalDebit) }}</strong></td>
            <td class="text-right text-green"><strong>{{ formatCurrency(selectedCustomerData()!.totalCredit) }}</strong></td>
            <td class="text-right"></td>
            <td class="text-right"></td>
          </tr>
          <tr class="closing-row">
            <td></td>
            <td></td>
            <td></td>
            <td><strong>D∆∞ cu·ªëi k·ª≥</strong></td>
            <td class="text-right"></td>
            <td class="text-right"></td>
            <td class="text-right text-blue">
              @if (selectedCustomerData()!.closingBalance > 0) {
                <strong>{{ formatCurrency(selectedCustomerData()!.closingBalance) }}</strong>
              }
            </td>
            <td class="text-right text-green">
              @if (selectedCustomerData()!.closingBalance < 0) {
                <strong>{{ formatCurrency(-selectedCustomerData()!.closingBalance) }}</strong>
              }
            </td>
          </tr>
        </tbody>
      </table>

      <button class="btn btn-secondary" style="margin-top: 16px;" (click)="showSummary()">
        ‚Üê Quay l·∫°i t·ªïng h·ª£p
      </button>
    </div>
  }

  <!-- Loading -->
  @if (isLoading()) {
    <div class="loading-overlay">
      <div class="spinner"></div>
    </div>
  }
</div>

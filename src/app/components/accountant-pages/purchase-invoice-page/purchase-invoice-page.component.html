<div class="purchase-invoice-page">
  <div class="page-header">
    <h2>H√≥a ƒê∆°n Mua V√†o</h2>
    <p class="subtitle">Danh s√°ch h√≥a ƒë∆°n ƒëi·ªán t·ª≠ mua v√†o t·ª´ hoadondientu.gdt.gov.vn</p>
  </div>

  <!-- Filter Section -->
  <div class="filter-section">
    <div class="filter-row">
      <div class="filter-group">
        <label>T·ª´ ng√†y</label>
        <input
          type="date"
          [ngModel]="fromDate()"
          (ngModelChange)="fromDate.set($event)"
          class="date-input"
        />
      </div>
      <div class="filter-group">
        <label>ƒê·∫øn ng√†y</label>
        <input
          type="date"
          [ngModel]="toDate()"
          (ngModelChange)="toDate.set($event)"
          class="date-input"
        />
      </div>
      <button class="btn btn-primary" (click)="onFilterChange()" [disabled]="loading()">
        @if (loading()) {
          <span class="spinner"></span> ƒêang t·∫£i...
        } @else {
          L·ªçc theo ng√†y
        }
      </button>
      <button class="btn btn-refresh" (click)="onRefresh()" [disabled]="loading()" title="T·∫£i l·∫°i t·ª´ T·ªïng c·ª•c Thu·∫ø">
        L√†m m·ªõi d·ªØ li·ªáu
      </button>
      <button class="btn btn-secondary" (click)="refreshToken()">
        C·∫≠p nh·∫≠t Token
      </button>
    </div>

    <!-- Search Row -->
    <div class="filter-row search-row">
      <div class="filter-group search-group">
        <label>T√¨m ki·∫øm</label>
        <input
          type="text"
          [ngModel]="searchQuery()"
          (ngModelChange)="searchQuery.set($event)"
          (keyup.enter)="onSearch()"
          class="search-input"
          placeholder="Nh·∫≠p t√™n/MST ng∆∞·ªùi b√°n, s·ªë h√≥a ƒë∆°n..."
        />
      </div>
      <button class="btn btn-search" (click)="onSearch()">
        T√¨m
      </button>
      @if (searchQuery()) {
        <button class="btn btn-clear" (click)="searchQuery.set(''); onSearch()">
          X√≥a
        </button>
      }
    </div>

    <!-- Cache Info -->
    @if (cacheInfo().count > 0) {
      <div class="cache-info">
        <span class="cache-count">{{ cacheInfo().count }} h√≥a ƒë∆°n trong b·ªô nh·ªõ</span>
        @if (cacheLastUpdatedText()) {
          <span class="cache-time">{{ cacheLastUpdatedText() }}</span>
        }
      </div>
    }
  </div>

  <!-- Summary Section -->
  <div class="summary-section">
    <div class="summary-card">
      <div class="summary-label">T·ªïng s·ªë h√≥a ƒë∆°n</div>
      <div class="summary-value">{{ totalInvoices() }}</div>
    </div>
    <div class="summary-card">
      <div class="summary-label">T·ªïng ti·ªÅn tr∆∞·ªõc thu·∫ø</div>
      <div class="summary-value">{{ formatCurrency(totalBeforeVat()) }}</div>
    </div>
    <div class="summary-card">
      <div class="summary-label">T·ªïng ti·ªÅn thu·∫ø</div>
      <div class="summary-value">{{ formatCurrency(totalVat()) }}</div>
    </div>
    <div class="summary-card highlight">
      <div class="summary-label">T·ªïng thanh to√°n</div>
      <div class="summary-value">{{ formatCurrency(totalAmount()) }}</div>
    </div>
  </div>

  <!-- Error Message -->
  @if (error()) {
    <div class="error-message">
      <span class="error-icon">!</span>
      {{ error() }}
    </div>
  }

  <!-- Loading Spinner -->
  @if (loading()) {
    <div class="loading-container">
      <div class="loading-spinner"></div>
      <p>ƒêang t·∫£i d·ªØ li·ªáu t·ª´ T·ªïng c·ª•c Thu·∫ø...</p>
    </div>
  }

  <!-- Invoice Table -->
  @if (!loading() && invoices().length > 0) {
    <!-- Pagination Controls Top -->
    <div class="pagination-container">
      <div class="pagination-info">
        Hi·ªÉn th·ªã {{ startIndex() + 1 }} - {{ endIndex() }} / {{ totalInvoices() }} h√≥a ƒë∆°n
      </div>
      <div class="pagination-controls">
        <div class="page-size-selector">
          <label>S·ªë d√≤ng:</label>
          <select [ngModel]="pageSize()" (ngModelChange)="onPageSizeChange($event)">
            @for (size of pageSizeOptions; track size) {
              <option [value]="size">{{ size }}</option>
            }
          </select>
        </div>
        <div class="page-buttons">
          <button class="page-btn" (click)="previousPage()" [disabled]="currentPage() === 1">
            &laquo; Tr∆∞·ªõc
          </button>
          @for (page of pageNumbers(); track $index) {
            @if (page === '...') {
              <span class="page-ellipsis">...</span>
            } @else {
              <button
                class="page-btn"
                [class.active]="page === currentPage()"
                (click)="goToPage(page)"
              >
                {{ page }}
              </button>
            }
          }
          <button class="page-btn" (click)="nextPage()" [disabled]="currentPage() === totalPages()">
            Sau &raquo;
          </button>
        </div>
      </div>
    </div>

    <div class="table-container">
      <table class="invoice-table">
        <thead>
          <tr>
            <th class="col-stt">STT</th>
            <th class="col-date">Ng√†y Hƒê</th>
            <th class="col-symbol">K√Ω hi·ªáu</th>
            <th class="col-number">S·ªë Hƒê</th>
            <th class="col-seller">Ng∆∞·ªùi b√°n</th>
            <th class="col-tax-code">MST ng∆∞·ªùi b√°n</th>
            <th class="col-amount text-right">Ti·ªÅn tr∆∞·ªõc thu·∫ø</th>
            <th class="col-vat text-right">Ti·ªÅn thu·∫ø</th>
            <th class="col-total text-right">T·ªïng ti·ªÅn</th>
            <th class="col-status">Tr·∫°ng th√°i</th>
          </tr>
        </thead>
        <tbody>
          @for (invoice of paginatedInvoices(); track invoice.id; let i = $index) {
            <tr [class]="getStatusClass(invoice)">
              <td class="col-stt">{{ startIndex() + i + 1 }}</td>
              <td class="col-date">{{ formatDate(invoice.tdlap) }}</td>
              <td class="col-symbol">{{ getInvoiceSymbol(invoice) }}</td>
              <td class="col-number">{{ invoice.shdon }}</td>
              <td class="col-seller" [title]="invoice.nbten">
                {{ invoice.nbten }}
              </td>
              <td class="col-tax-code">{{ invoice.nbmst }}</td>
              <td class="col-amount text-right">{{ formatCurrency(invoice.tgtcthue) }}</td>
              <td class="col-vat text-right">{{ formatCurrency(invoice.tgtthue) }}</td>
              <td class="col-total text-right">{{ formatCurrency(invoice.tgtttbso) }}</td>
              <td class="col-status">
                <span class="status-badge" [class]="getStatusClass(invoice)">
                  {{ getStatusText(invoice) }}
                </span>
                @if (getNatureText(invoice)) {
                  <br><small class="nature-text">{{ getNatureText(invoice) }}</small>
                }
              </td>
            </tr>
          }
        </tbody>
        <tfoot>
          <tr class="total-row">
            <td colspan="6" class="text-right"><strong>T·ªïng c·ªông:</strong></td>
            <td class="text-right"><strong>{{ formatCurrency(totalBeforeVat()) }}</strong></td>
            <td class="text-right"><strong>{{ formatCurrency(totalVat()) }}</strong></td>
            <td class="text-right"><strong>{{ formatCurrency(totalAmount()) }}</strong></td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <!-- Pagination Controls Bottom -->
    <div class="pagination-container pagination-bottom">
      <div class="pagination-info">
        Trang {{ currentPage() }} / {{ totalPages() }}
      </div>
      <div class="page-buttons">
        <button class="page-btn" (click)="previousPage()" [disabled]="currentPage() === 1">
          &laquo; Tr∆∞·ªõc
        </button>
        @for (page of pageNumbers(); track $index) {
          @if (page === '...') {
            <span class="page-ellipsis">...</span>
          } @else {
            <button
              class="page-btn"
              [class.active]="page === currentPage()"
              (click)="goToPage(page)"
            >
              {{ page }}
            </button>
          }
        }
        <button class="page-btn" (click)="nextPage()" [disabled]="currentPage() === totalPages()">
          Sau &raquo;
        </button>
      </div>
    </div>
  }

  <!-- Empty State -->
  @if (!loading() && !error() && invoices().length === 0) {
    <div class="empty-state">
      <div class="empty-icon">üìÑ</div>
      <h3>Kh√¥ng c√≥ h√≥a ƒë∆°n</h3>
      <p>Kh√¥ng t√¨m th·∫•y h√≥a ƒë∆°n mua v√†o trong kho·∫£ng th·ªùi gian ƒë√£ ch·ªçn.</p>
    </div>
  }
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     INVOICE PAGE - H√ìA ƒê∆†N MUA V√ÄO / B√ÅN RA
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

<div class="invoice-page">

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       HEADER
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">{{ getPageTitle() }}</h1>
      <p class="page-subtitle">{{ getPageSubtitle() }}</p>
    </div>
    <div class="header-actions">
      <button class="btn btn-primary" (click)="openCreateModal()">
        <span class="icon">+</span>
        T·∫°o h√≥a ƒë∆°n m·ªõi
      </button>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       SUMMARY CARDS
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="summary-cards" *ngIf="summary">
    <div class="summary-card card-total">
      <div class="card-icon">üìÑ</div>
      <div class="card-content">
        <span class="card-label">T·ªïng h√≥a ƒë∆°n</span>
        <span class="card-value">{{ summary.totalInvoices }}</span>
      </div>
    </div>

    <div class="summary-card card-amount">
      <div class="card-icon">üí∞</div>
      <div class="card-content">
        <span class="card-label">T·ªïng gi√° tr·ªã</span>
        <span class="card-value">{{ formatCurrency(summary.totalAmount) }}</span>
      </div>
    </div>

    <div class="summary-card card-vat">
      <div class="card-icon">üìä</div>
      <div class="card-content">
        <span class="card-label">T·ªïng VAT</span>
        <span class="card-value">{{ formatCurrency(summary.totalVAT) }}</span>
      </div>
    </div>

    <div class="summary-card card-paid">
      <div class="card-icon">‚úÖ</div>
      <div class="card-content">
        <span class="card-label">ƒê√£ thanh to√°n</span>
        <span class="card-value">{{ formatCurrency(summary.totalPaid) }}</span>
      </div>
    </div>

    <div class="summary-card card-unpaid">
      <div class="card-icon">‚è≥</div>
      <div class="card-content">
        <span class="card-label">Ch∆∞a thanh to√°n</span>
        <span class="card-value">{{ formatCurrency(summary.totalUnpaid) }}</span>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       FILTERS
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="filter-section">
    <div class="filter-row">
      <div class="filter-group">
        <label>T·ª´ ng√†y</label>
        <input type="date" [(ngModel)]="filter.fromDate" (change)="onFilterChange()">
      </div>

      <div class="filter-group">
        <label>ƒê·∫øn ng√†y</label>
        <input type="date" [(ngModel)]="filter.toDate" (change)="onFilterChange()">
      </div>

      <div class="filter-group">
        <label>Thanh to√°n</label>
        <select [(ngModel)]="filter.paymentStatus" (change)="onFilterChange()">
          <option value="">T·∫•t c·∫£</option>
          <option value="UNPAID">Ch∆∞a thanh to√°n</option>
          <option value="PARTIAL">Thanh to√°n m·ªôt ph·∫ßn</option>
          <option value="PAID">ƒê√£ thanh to√°n</option>
        </select>
      </div>

      <div class="filter-group filter-search">
        <label>T√¨m ki·∫øm</label>
        <input type="text"
               [(ngModel)]="filter.search"
               (input)="onFilterChange()"
               placeholder="S·ªë Hƒê, t√™n KH/NCC, MST...">
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       STATUS TABS
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="status-tabs">
    <button class="tab-btn"
            [class.active]="activeStatusTab === 'all'"
            (click)="onStatusTabChange('all')">
      T·∫•t c·∫£ ({{ invoices.length }})
    </button>
    <button class="tab-btn"
            [class.active]="activeStatusTab === 'DRAFT'"
            (click)="onStatusTabChange('DRAFT')">
      Nh√°p ({{ getCountByStatus('DRAFT') }})
    </button>
    <button class="tab-btn"
            [class.active]="activeStatusTab === 'POSTED'"
            (click)="onStatusTabChange('POSTED')">
      ƒê√£ ghi s·ªï ({{ getCountByStatus('POSTED') }})
    </button>
    <button class="tab-btn"
            [class.active]="activeStatusTab === 'CANCELLED'"
            (click)="onStatusTabChange('CANCELLED')">
      ƒê√£ h·ªßy ({{ getCountByStatus('CANCELLED') }})
    </button>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       INVOICE TABLE
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="table-container">
    <table class="data-table">
      <thead>
        <tr>
          <th class="col-no">STT</th>
          <th class="col-invoice-no">S·ªë h√≥a ƒë∆°n</th>
          <th class="col-date">Ng√†y Hƒê</th>
          <th class="col-partner">{{ invoiceType === 'OUTPUT' ? 'Kh√°ch h√†ng' : 'Nh√† cung c·∫•p' }}</th>
          <th class="col-tax">MST</th>
          <th class="col-amount">Ti·ªÅn h√†ng</th>
          <th class="col-vat">VAT</th>
          <th class="col-total">T·ªïng c·ªông</th>
          <th class="col-payment">Thanh to√°n</th>
          <th class="col-status">Tr·∫°ng th√°i</th>
          <th class="col-actions">Thao t√°c</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let invoice of filteredInvoices; let i = index"
            [class.overdue]="isOverdue(invoice)"
            [class.cancelled]="invoice.status === 'CANCELLED'">
          <td class="col-no">{{ i + 1 }}</td>
          <td class="col-invoice-no">
            <span class="invoice-series">{{ invoice.invoiceSeries }}</span>
            <span class="invoice-number">{{ invoice.invoiceNo }}</span>
          </td>
          <td class="col-date">{{ formatDate(invoice.invoiceDate) }}</td>
          <td class="col-partner">
            <span class="partner-name">{{ invoice.partnerName }}</span>
          </td>
          <td class="col-tax">{{ invoice.partnerTaxCode }}</td>
          <td class="col-amount text-right">{{ formatNumber(invoice.subTotal) }}</td>
          <td class="col-vat text-right">{{ formatNumber(invoice.totalVAT) }}</td>
          <td class="col-total text-right">{{ formatNumber(invoice.grandTotal) }}</td>
          <td class="col-payment">
            <span class="payment-badge" [class]="getPaymentStatusClass(invoice.paymentStatus)">
              {{ getPaymentStatusLabel(invoice.paymentStatus) }}
            </span>
            <div class="payment-info" *ngIf="invoice.paymentStatus !== 'PAID' && invoice.status !== 'CANCELLED'">
              C√≤n l·∫°i: {{ formatNumber(getRemainingAmount(invoice)) }}
            </div>
          </td>
          <td class="col-status">
            <span class="status-badge" [class]="getStatusClass(invoice.status)">
              {{ getStatusLabel(invoice.status) }}
            </span>
          </td>
          <td class="col-actions">
            <div class="action-buttons">
              <button class="btn-icon btn-view" title="Xem chi ti·∫øt" (click)="viewDetail(invoice)">üëÅÔ∏è</button>

              <button class="btn-icon btn-post" title="Ghi s·ªï"
                      *ngIf="invoice.status === 'DRAFT'"
                      (click)="postInvoice(invoice)">üìù</button>

              <button class="btn-icon btn-payment" title="Thanh to√°n"
                      *ngIf="invoice.status === 'POSTED' && invoice.paymentStatus !== 'PAID'"
                      (click)="openPaymentModal(invoice)">üí≥</button>

              <button class="btn-icon btn-journal" title="Xem b√∫t to√°n"
                      *ngIf="invoice.status === 'POSTED'"
                      (click)="viewJournalEntries(invoice)">üìã</button>

              <button class="btn-icon btn-cancel" title="H·ªßy"
                      *ngIf="invoice.status !== 'CANCELLED'"
                      (click)="openCancelModal(invoice)">‚úï</button>

              <button class="btn-icon btn-delete" title="X√≥a"
                      *ngIf="invoice.status === 'DRAFT'"
                      (click)="deleteInvoice(invoice)">üóëÔ∏è</button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <div class="empty-state" *ngIf="filteredInvoices.length === 0">
      <div class="empty-icon">üìÑ</div>
      <p>Kh√¥ng c√≥ h√≥a ƒë∆°n n√†o</p>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     CREATE INVOICE MODAL
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" *ngIf="showCreateModal" (click)="showCreateModal = false">
  <div class="modal modal-large" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>T·∫°o {{ getPageTitle() }} m·ªõi</h2>
      <button class="btn-close" (click)="showCreateModal = false">&times;</button>
    </div>

    <div class="modal-body">
      <!-- Invoice Info -->
      <div class="form-section">
        <h3 class="section-title">Th√¥ng tin h√≥a ƒë∆°n</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>K√Ω hi·ªáu <span class="required">*</span></label>
            <input type="text" [(ngModel)]="formData.invoiceSeries" placeholder="1C25TTT">
          </div>
          <div class="form-group">
            <label>Ng√†y h√≥a ƒë∆°n <span class="required">*</span></label>
            <input type="date" [(ngModel)]="formData.invoiceDate">
          </div>
          <div class="form-group">
            <label>H√¨nh th·ª©c TT</label>
            <select [(ngModel)]="formData.paymentMethod">
              <option value="CASH">Ti·ªÅn m·∫∑t</option>
              <option value="BANK">Chuy·ªÉn kho·∫£n</option>
              <option value="CREDIT">C√¥ng n·ª£</option>
            </select>
          </div>
          <div class="form-group">
            <label>H·∫°n thanh to√°n</label>
            <input type="date" [(ngModel)]="formData.dueDate">
          </div>
        </div>
      </div>

      <!-- Partner Info -->
      <div class="form-section">
        <h3 class="section-title">{{ invoiceType === 'OUTPUT' ? 'Th√¥ng tin kh√°ch h√†ng' : 'Th√¥ng tin nh√† cung c·∫•p' }}</h3>
        <div class="form-grid">
          <div class="form-group col-span-2">
            <label>{{ invoiceType === 'OUTPUT' ? 'T√™n kh√°ch h√†ng' : 'T√™n nh√† cung c·∫•p' }} <span class="required">*</span></label>
            <input type="text" [(ngModel)]="formData.partnerName" [placeholder]="invoiceType === 'OUTPUT' ? 'Nh·∫≠p t√™n kh√°ch h√†ng' : 'Nh·∫≠p t√™n nh√† cung c·∫•p'">
          </div>
          <div class="form-group">
            <label>M√£ s·ªë thu·∫ø</label>
            <input type="text" [(ngModel)]="formData.partnerTaxCode" placeholder="0123456789">
          </div>
          <div class="form-group col-span-2">
            <label>ƒê·ªãa ch·ªâ</label>
            <input type="text" [(ngModel)]="formData.partnerAddress" placeholder="ƒê·ªãa ch·ªâ">
          </div>
        </div>
      </div>

      <!-- Invoice Lines -->
      <div class="form-section">
        <div class="section-header">
          <h3 class="section-title">Chi ti·∫øt h√†ng h√≥a/d·ªãch v·ª•</h3>
          <button class="btn btn-secondary btn-sm" (click)="addLine()">+ Th√™m d√≤ng</button>
        </div>

        <div class="lines-table-container">
          <table class="lines-table">
            <thead>
              <tr>
                <th class="col-line-no">#</th>
                <th class="col-item-code">M√£</th>
                <th class="col-item-name">T√™n h√†ng h√≥a/d·ªãch v·ª•</th>
                <th class="col-unit">ƒêVT</th>
                <th class="col-qty">SL</th>
                <th class="col-price">ƒê∆°n gi√°</th>
                <th class="col-line-amount">Th√†nh ti·ªÅn</th>
                <th class="col-vat-rate">VAT</th>
                <th class="col-vat-amount">Ti·ªÅn VAT</th>
                <th class="col-account">TK</th>
                <th class="col-line-action"></th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let line of formLines; let i = index">
                <td class="col-line-no">{{ line.lineNo }}</td>
                <td class="col-item-code">
                  <input type="text" [(ngModel)]="line.productCode" placeholder="M√£">
                </td>
                <td class="col-item-name">
                  <input type="text" [(ngModel)]="line.productName" placeholder="T√™n h√†ng h√≥a/d·ªãch v·ª•">
                </td>
                <td class="col-unit">
                  <select [(ngModel)]="line.unit">
                    <option *ngFor="let u of units" [value]="u">{{ u }}</option>
                  </select>
                </td>
                <td class="col-qty">
                  <input type="number" [(ngModel)]="line.quantity" (change)="onLineChange(i)" min="0">
                </td>
                <td class="col-price">
                  <input type="number" [(ngModel)]="line.unitPrice" (change)="onLineChange(i)" min="0">
                </td>
                <td class="col-line-amount text-right">{{ formatNumber(line.amount) }}</td>
                <td class="col-vat-rate">
                  <select [(ngModel)]="line.vatRate" (change)="onLineChange(i)">
                    <option *ngFor="let vat of vatRates" [value]="vat.value">{{ vat.label }}</option>
                  </select>
                </td>
                <td class="col-vat-amount text-right">{{ formatNumber(line.vatAmount) }}</td>
                <td class="col-account">
                  <select [(ngModel)]="line.accountCode" (change)="onAccountChange(i)">
                    <option *ngFor="let acc of getAccounts()" [value]="acc.code">{{ acc.code }} - {{ acc.name }}</option>
                  </select>
                </td>
                <td class="col-line-action">
                  <button class="btn-icon btn-remove" (click)="removeLine(i)" *ngIf="formLines.length > 1">‚úï</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Totals -->
        <div class="invoice-totals">
          <div class="total-row">
            <span class="total-label">C·ªông ti·ªÅn h√†ng:</span>
            <span class="total-value">{{ formatCurrency(getFormTotals().subTotal) }}</span>
          </div>
          <div class="total-row">
            <span class="total-label">Ti·ªÅn thu·∫ø GTGT:</span>
            <span class="total-value">{{ formatCurrency(getFormTotals().totalVAT) }}</span>
          </div>
          <div class="total-row total-grand">
            <span class="total-label">T·ªïng c·ªông ti·ªÅn thanh to√°n:</span>
            <span class="total-value">{{ formatCurrency(getFormTotals().grandTotal) }}</span>
          </div>
        </div>
      </div>

      <!-- Notes -->
      <div class="form-section">
        <div class="form-group">
          <label>Ghi ch√∫</label>
          <textarea [(ngModel)]="formData.note" rows="2" placeholder="Ghi ch√∫ th√™m..."></textarea>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="showCreateModal = false">H·ªßy</button>
      <button class="btn btn-primary" (click)="saveInvoice()" [disabled]="loading">
        {{ loading ? 'ƒêang l∆∞u...' : 'L∆∞u h√≥a ƒë∆°n' }}
      </button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     DETAIL MODAL
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" *ngIf="showDetailModal && selectedInvoice" (click)="closeDetailModal()">
  <div class="modal modal-large" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Chi ti·∫øt h√≥a ƒë∆°n {{ selectedInvoice.invoiceSeries }} - {{ selectedInvoice.invoiceNo }}</h2>
      <button class="btn-close" (click)="closeDetailModal()">&times;</button>
    </div>

    <div class="modal-body">
      <!-- Status Banner -->
      <div class="status-banner" [class]="getStatusClass(selectedInvoice.status)">
        <span class="status-icon">
          {{ selectedInvoice.status === 'DRAFT' ? 'üìù' :
             selectedInvoice.status === 'POSTED' ? 'üìã' : '‚úï' }}
        </span>
        <span class="status-text">{{ getStatusLabel(selectedInvoice.status) }}</span>
        <span class="journal-no" *ngIf="selectedInvoice.taxAuthCode">
          M√£ CQT: {{ selectedInvoice.taxAuthCode }}
        </span>
      </div>

      <!-- Invoice Info Grid -->
      <div class="detail-grid">
        <div class="detail-section">
          <h4>Th√¥ng tin h√≥a ƒë∆°n</h4>
          <div class="detail-item">
            <label>K√Ω hi·ªáu - S·ªë:</label>
            <span>{{ selectedInvoice.invoiceSeries }} - {{ selectedInvoice.invoiceNo }}</span>
          </div>
          <div class="detail-item">
            <label>Ng√†y h√≥a ƒë∆°n:</label>
            <span>{{ formatDate(selectedInvoice.invoiceDate) }}</span>
          </div>
          <div class="detail-item">
            <label>H√¨nh th·ª©c TT:</label>
            <span>{{ getPaymentMethodLabel(selectedInvoice.paymentMethod) }}</span>
          </div>
          <div class="detail-item" *ngIf="selectedInvoice.dueDate">
            <label>H·∫°n thanh to√°n:</label>
            <span [class.overdue-text]="isOverdue(selectedInvoice)">
              {{ formatDate(selectedInvoice.dueDate) }}
              <span *ngIf="isOverdue(selectedInvoice)">(Qu√° h·∫°n)</span>
            </span>
          </div>
        </div>

        <div class="detail-section">
          <h4>{{ invoiceType === 'OUTPUT' ? 'Kh√°ch h√†ng' : 'Nh√† cung c·∫•p' }}</h4>
          <div class="detail-item">
            <label>T√™n:</label>
            <span>{{ selectedInvoice.partnerName }}</span>
          </div>
          <div class="detail-item" *ngIf="selectedInvoice.partnerTaxCode">
            <label>MST:</label>
            <span>{{ selectedInvoice.partnerTaxCode }}</span>
          </div>
          <div class="detail-item" *ngIf="selectedInvoice.partnerAddress">
            <label>ƒê·ªãa ch·ªâ:</label>
            <span>{{ selectedInvoice.partnerAddress }}</span>
          </div>
        </div>

        <div class="detail-section">
          <h4>Thanh to√°n</h4>
          <div class="detail-item">
            <label>T·ªïng ti·ªÅn:</label>
            <span class="amount-large">{{ formatCurrency(selectedInvoice.grandTotal) }}</span>
          </div>
          <div class="detail-item">
            <label>ƒê√£ thanh to√°n:</label>
            <span class="amount-paid">{{ formatCurrency(selectedInvoice.paidAmount || 0) }}</span>
          </div>
          <div class="detail-item">
            <label>C√≤n l·∫°i:</label>
            <span class="amount-remaining">{{ formatCurrency(getRemainingAmount(selectedInvoice)) }}</span>
          </div>
          <div class="detail-item">
            <label>Tr·∫°ng th√°i:</label>
            <span class="payment-badge" [class]="getPaymentStatusClass(selectedInvoice.paymentStatus)">
              {{ getPaymentStatusLabel(selectedInvoice.paymentStatus) }}
            </span>
          </div>
        </div>
      </div>

      <!-- Invoice Lines -->
      <div class="detail-lines">
        <h4>Chi ti·∫øt h√†ng h√≥a/d·ªãch v·ª•</h4>
        <table class="lines-table">
          <thead>
            <tr>
              <th>#</th>
              <th>M√£</th>
              <th>T√™n h√†ng h√≥a/d·ªãch v·ª•</th>
              <th>ƒêVT</th>
              <th class="text-right">SL</th>
              <th class="text-right">ƒê∆°n gi√°</th>
              <th class="text-right">Th√†nh ti·ªÅn</th>
              <th class="text-right">VAT</th>
              <th class="text-right">Ti·ªÅn VAT</th>
              <th>TK</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let line of selectedInvoice.lines">
              <td>{{ line.lineNo }}</td>
              <td>{{ line.productCode }}</td>
              <td>{{ line.productName }}</td>
              <td>{{ line.unit }}</td>
              <td class="text-right">{{ formatNumber(line.quantity) }}</td>
              <td class="text-right">{{ formatNumber(line.unitPrice) }}</td>
              <td class="text-right">{{ formatNumber(line.amount) }}</td>
              <td class="text-right">{{ line.vatRate }}%</td>
              <td class="text-right">{{ formatNumber(line.vatAmount) }}</td>
              <td>{{ line.accountCode }}</td>
            </tr>
          </tbody>
          <tfoot>
            <tr>
              <td colspan="6" class="text-right"><strong>C·ªông:</strong></td>
              <td class="text-right"><strong>{{ formatNumber(selectedInvoice.subTotal) }}</strong></td>
              <td></td>
              <td class="text-right"><strong>{{ formatNumber(selectedInvoice.totalVAT) }}</strong></td>
              <td></td>
            </tr>
            <tr class="total-row">
              <td colspan="6" class="text-right"><strong>T·ªïng c·ªông:</strong></td>
              <td colspan="4" class="text-right"><strong>{{ formatCurrency(selectedInvoice.grandTotal) }}</strong></td>
            </tr>
          </tfoot>
        </table>
      </div>

      <!-- Audit Info -->
      <div class="audit-info">
        <div class="audit-item" *ngIf="selectedInvoice.preparedBy">
          <span class="audit-label">Ng∆∞·ªùi l·∫≠p:</span>
          <span>{{ selectedInvoice.preparedBy }}</span>
          <small>{{ formatDateTime(selectedInvoice.preparedAt) }}</small>
        </div>
        <div class="audit-item" *ngIf="selectedInvoice.postedBy">
          <span class="audit-label">Ng∆∞·ªùi ghi s·ªï:</span>
          <span>{{ selectedInvoice.postedBy }}</span>
          <small>{{ formatDateTime(selectedInvoice.postedAt) }}</small>
        </div>
        <div class="audit-item cancelled-info" *ngIf="selectedInvoice.cancelledBy">
          <span class="audit-label">Ng∆∞·ªùi h·ªßy:</span>
          <span>{{ selectedInvoice.cancelledBy }}</span>
          <small>{{ formatDateTime(selectedInvoice.cancelledAt) }}</small>
          <div class="cancel-reason" *ngIf="selectedInvoice.cancelReason">
            L√Ω do: {{ selectedInvoice.cancelReason }}
          </div>
        </div>
      </div>

      <!-- Notes -->
      <div class="detail-notes" *ngIf="selectedInvoice.note">
        <h4>Ghi ch√∫</h4>
        <p>{{ selectedInvoice.note }}</p>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeDetailModal()">ƒê√≥ng</button>

      <button class="btn btn-primary" *ngIf="selectedInvoice.status === 'DRAFT'"
              (click)="postInvoice(selectedInvoice)">
        Ghi s·ªï
      </button>

      <button class="btn btn-info" *ngIf="selectedInvoice.status === 'POSTED' && selectedInvoice.paymentStatus !== 'PAID'"
              (click)="openPaymentModal(selectedInvoice)">
        Thanh to√°n
      </button>

      <button class="btn btn-warning" *ngIf="selectedInvoice.status === 'POSTED'"
              (click)="viewJournalEntries(selectedInvoice)">
        Xem b√∫t to√°n
      </button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     JOURNAL ENTRIES MODAL
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" *ngIf="showJournalModal && selectedInvoice" (click)="showJournalModal = false">
  <div class="modal modal-medium" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>B√∫t to√°n h·∫°ch to√°n</h2>
      <button class="btn-close" (click)="showJournalModal = false">&times;</button>
    </div>

    <div class="modal-body">
      <div class="journal-info">
        <p><strong>H√≥a ƒë∆°n:</strong> {{ selectedInvoice.invoiceSeries }} - {{ selectedInvoice.invoiceNo }}</p>
        <p><strong>M√£ CQT:</strong> {{ selectedInvoice.taxAuthCode }}</p>
        <p><strong>Ng√†y ghi s·ªï:</strong> {{ formatDateTime(selectedInvoice.postedAt) }}</p>
      </div>

      <table class="journal-table">
        <thead>
          <tr>
            <th>TK</th>
            <th>Di·ªÖn gi·∫£i</th>
            <th class="text-right">N·ª£</th>
            <th class="text-right">C√≥</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let entry of getJournalEntries()">
            <td>{{ entry.accountCode }}</td>
            <td>{{ entry.description }}</td>
            <td class="text-right">{{ entry.debitAmount > 0 ? formatNumber(entry.debitAmount) : '' }}</td>
            <td class="text-right">{{ entry.creditAmount > 0 ? formatNumber(entry.creditAmount) : '' }}</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="showJournalModal = false">ƒê√≥ng</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     CANCEL MODAL
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" *ngIf="showCancelModal && selectedInvoice" (click)="showCancelModal = false">
  <div class="modal modal-small" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>H·ªßy h√≥a ƒë∆°n</h2>
      <button class="btn-close" (click)="showCancelModal = false">&times;</button>
    </div>

    <div class="modal-body">
      <div class="warning-message">
        <span class="warning-icon">‚ö†Ô∏è</span>
        <p>B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy h√≥a ƒë∆°n <strong>{{ selectedInvoice.invoiceSeries }} - {{ selectedInvoice.invoiceNo }}</strong>?</p>
      </div>

      <div class="form-group">
        <label>L√Ω do h·ªßy <span class="required">*</span></label>
        <textarea [(ngModel)]="cancelReason" rows="3" placeholder="Nh·∫≠p l√Ω do h·ªßy h√≥a ƒë∆°n..."></textarea>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="showCancelModal = false">ƒê√≥ng</button>
      <button class="btn btn-danger" (click)="confirmCancel()" [disabled]="loading">
        X√°c nh·∫≠n h·ªßy
      </button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     PAYMENT MODAL
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" *ngIf="showPaymentModal && selectedInvoice" (click)="showPaymentModal = false">
  <div class="modal modal-small" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>C·∫≠p nh·∫≠t thanh to√°n</h2>
      <button class="btn-close" (click)="showPaymentModal = false">&times;</button>
    </div>

    <div class="modal-body">
      <div class="payment-summary">
        <div class="payment-row">
          <span>T·ªïng ti·ªÅn h√≥a ƒë∆°n:</span>
          <span class="amount">{{ formatCurrency(selectedInvoice.grandTotal) }}</span>
        </div>
        <div class="payment-row">
          <span>ƒê√£ thanh to√°n:</span>
          <span class="amount paid">{{ formatCurrency(selectedInvoice.paidAmount || 0) }}</span>
        </div>
        <div class="payment-row remaining">
          <span>C√≤n l·∫°i:</span>
          <span class="amount">{{ formatCurrency(getRemainingAmount(selectedInvoice)) }}</span>
        </div>
      </div>

      <div class="form-group">
        <label>S·ªë ti·ªÅn thanh to√°n <span class="required">*</span></label>
        <input type="number" [(ngModel)]="paymentAmount" [max]="getRemainingAmount(selectedInvoice)" min="0">
      </div>

      <div class="form-group">
        <label>Ng√†y thanh to√°n <span class="required">*</span></label>
        <input type="date" [(ngModel)]="paymentDate">
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="showPaymentModal = false">ƒê√≥ng</button>
      <button class="btn btn-primary" (click)="confirmPayment()" [disabled]="loading">
        X√°c nh·∫≠n
      </button>
    </div>
  </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" *ngIf="loading">
  <div class="spinner"></div>
</div>

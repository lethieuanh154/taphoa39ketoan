<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     PRODUCT PAGE - DANH M·ª§C H√ÄNG H√ìA
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

<div class="product-page">

  <!-- HEADER -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">Danh m·ª•c h√†ng h√≥a</h1>
      <p class="page-subtitle">Qu·∫£n l√Ω h√†ng h√≥a, d·ªãch v·ª• - T·ªìn kho (TK 156, 155, 152, 153)</p>
    </div>
    <div class="header-actions">
      <button class="btn btn-primary" (click)="openCreateModal()">
        <span class="icon">+</span>
        Th√™m h√†ng h√≥a
      </button>
    </div>
  </div>

  <!-- STATS CARDS -->
  <div class="stats-cards">
    <div class="stat-card card-total">
      <div class="stat-icon">üì¶</div>
      <div class="stat-content">
        <span class="stat-label">T·ªïng m·∫∑t h√†ng</span>
        <span class="stat-value">{{ stats.total }}</span>
      </div>
    </div>
    <div class="stat-card card-active">
      <div class="stat-icon">‚úÖ</div>
      <div class="stat-content">
        <span class="stat-label">ƒêang kinh doanh</span>
        <span class="stat-value">{{ stats.active }}</span>
      </div>
    </div>
    <div class="stat-card card-lowstock">
      <div class="stat-icon">‚ö†Ô∏è</div>
      <div class="stat-content">
        <span class="stat-label">T·ªìn kho th·∫•p</span>
        <span class="stat-value">{{ stats.lowStock }}</span>
      </div>
    </div>
    <div class="stat-card card-goods">
      <div class="stat-icon">üè™</div>
      <div class="stat-content">
        <span class="stat-label">H√†ng h√≥a</span>
        <span class="stat-value">{{ stats.byType['GOODS'] || 0 }}</span>
      </div>
    </div>
    <div class="stat-card card-value">
      <div class="stat-icon">üí∞</div>
      <div class="stat-content">
        <span class="stat-label">Gi√° tr·ªã t·ªìn</span>
        <span class="stat-value">{{ formatCurrency(stats.totalValue) }}</span>
      </div>
    </div>
  </div>

  <!-- FILTERS -->
  <div class="filter-section">
    <div class="filter-row">
      <div class="filter-group filter-search">
        <label>T√¨m ki·∫øm</label>
        <input type="text" [(ngModel)]="filter.search" (input)="onFilterChange()" placeholder="M√£, t√™n, barcode, th∆∞∆°ng hi·ªáu...">
      </div>
      <div class="filter-group">
        <label>Lo·∫°i</label>
        <select [(ngModel)]="filter.productType" (change)="onFilterChange()">
          <option [ngValue]="undefined">T·∫•t c·∫£</option>
          <option *ngFor="let type of productTypes" [value]="type.value">{{ type.label }}</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Nh√≥m</label>
        <select [(ngModel)]="filter.productGroup" (change)="onFilterChange()">
          <option [ngValue]="undefined">T·∫•t c·∫£</option>
          <option *ngFor="let group of productGroups" [value]="group.value">{{ group.label }}</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Tr·∫°ng th√°i</label>
        <select [ngModel]="filter.status || ''" (ngModelChange)="onStatusFilterChange($event)">
          <option value="">T·∫•t c·∫£</option>
          <option *ngFor="let s of productStatus" [value]="s.value">{{ s.label }}</option>
        </select>
      </div>
    </div>
  </div>

  <!-- TABLE -->
  <div class="table-container">
    <table class="data-table">
      <thead>
        <tr>
          <th class="col-no">STT</th>
          <th class="col-code">M√£ SP</th>
          <th class="col-name">T√™n h√†ng h√≥a</th>
          <th class="col-type">Lo·∫°i</th>
          <th class="col-unit">ƒêVT</th>
          <th class="col-cost text-right">Gi√° v·ªën</th>
          <th class="col-sale text-right">Gi√° b√°n</th>
          <th class="col-vat">VAT</th>
          <th class="col-stock text-right">T·ªìn kho</th>
          <th class="col-status">Tr·∫°ng th√°i</th>
          <th class="col-actions">Thao t√°c</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let product of filteredProducts; let i = index"
            [class.inactive]="product.status !== 'ACTIVE'"
            [class.low-stock]="isLowStock(product)">
          <td class="col-no">{{ i + 1 }}</td>
          <td class="col-code">
            <span class="product-code">{{ product.code }}</span>
            <span class="barcode" *ngIf="product.barcode">{{ product.barcode }}</span>
          </td>
          <td class="col-name">
            <div class="product-info">
              <span class="product-name">{{ product.name }}</span>
              <span class="product-brand" *ngIf="product.brand">{{ product.brand }}</span>
            </div>
          </td>
          <td class="col-type">
            <span class="type-badge" [class]="'type-' + product.productType.toLowerCase()">
              {{ getProductTypeLabel(product.productType) }}
            </span>
          </td>
          <td class="col-unit">{{ product.unit }}</td>
          <td class="col-cost text-right">{{ formatNumber(product.costPrice) }}</td>
          <td class="col-sale text-right">{{ formatNumber(product.salePrice) }}</td>
          <td class="col-vat">{{ getVatLabel(product.vatRate) }}</td>
          <td class="col-stock text-right">
            <span [class.warning]="isLowStock(product)" [class.danger]="product.currentStock <= 0">
              {{ formatNumber(product.currentStock) }}
            </span>
          </td>
          <td class="col-status">
            <span class="status-badge" [class]="getStatusClass(product.status)">{{ getStatusLabel(product.status) }}</span>
          </td>
          <td class="col-actions">
            <div class="action-buttons">
              <button class="btn-icon btn-view" title="Xem" (click)="viewDetail(product)">üëÅÔ∏è</button>
              <button class="btn-icon btn-edit" title="S·ª≠a" (click)="openEditModal(product)">‚úèÔ∏è</button>
              <button class="btn-icon btn-delete" title="X√≥a" (click)="confirmDelete(product)">üóëÔ∏è</button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
    <div class="empty-state" *ngIf="filteredProducts.length === 0">
      <div class="empty-icon">üì¶</div>
      <p>Kh√¥ng c√≥ h√†ng h√≥a n√†o</p>
    </div>
  </div>
</div>

<!-- CREATE/EDIT MODAL -->
<div class="modal-overlay" *ngIf="showCreateModal" (click)="closeCreateModal()">
  <div class="modal modal-large" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ isEditMode ? 'S·ª≠a h√†ng h√≥a' : 'Th√™m h√†ng h√≥a m·ªõi' }}</h2>
      <button class="btn-close" (click)="closeCreateModal()">&times;</button>
    </div>
    <div class="modal-body">
      <!-- Basic Info -->
      <div class="form-section">
        <h3 class="section-title">Th√¥ng tin c∆° b·∫£n</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>M√£ h√†ng h√≥a <span class="required">*</span></label>
            <input type="text" [(ngModel)]="formData.code" [disabled]="isEditMode">
          </div>
          <div class="form-group col-span-2">
            <label>T√™n h√†ng h√≥a <span class="required">*</span></label>
            <input type="text" [(ngModel)]="formData.name" placeholder="Nh·∫≠p t√™n h√†ng h√≥a">
          </div>
          <div class="form-group">
            <label>Barcode</label>
            <input type="text" [(ngModel)]="formData.barcode" placeholder="M√£ v·∫°ch">
          </div>
          <div class="form-group">
            <label>Lo·∫°i</label>
            <select [(ngModel)]="formData.productType" (change)="onProductTypeChange()">
              <option *ngFor="let type of productTypes" [value]="type.value">{{ type.label }}</option>
            </select>
          </div>
          <div class="form-group">
            <label>Nh√≥m</label>
            <select [(ngModel)]="formData.productGroup">
              <option *ngFor="let group of productGroups" [value]="group.value">{{ group.label }}</option>
            </select>
          </div>
          <div class="form-group">
            <label>Tr·∫°ng th√°i</label>
            <select [(ngModel)]="formData.status">
              <option *ngFor="let s of productStatus" [value]="s.value">{{ s.label }}</option>
            </select>
          </div>
          <div class="form-group">
            <label>Th∆∞∆°ng hi·ªáu</label>
            <input type="text" [(ngModel)]="formData.brand">
          </div>
        </div>
      </div>

      <!-- Units -->
      <div class="form-section">
        <div class="section-header">
          <h3 class="section-title">ƒê∆°n v·ªã t√≠nh</h3>
          <button class="btn btn-secondary btn-sm" (click)="addUnit()">+ Th√™m ƒêVT</button>
        </div>
        <div class="units-list">
          <div class="unit-item" *ngFor="let unit of formUnits; let i = index">
            <select [(ngModel)]="unit.unit">
              <option value="">-- Ch·ªçn --</option>
              <option *ngFor="let u of commonUnits" [value]="u">{{ u }}</option>
            </select>
            <input type="number" [(ngModel)]="unit.conversionRate" min="1" placeholder="T·ª∑ l·ªá">
            <label class="checkbox-label">
              <input type="radio" name="defaultUnit" [checked]="unit.isDefault" (change)="setDefaultUnit(i)">
              Ch√≠nh
            </label>
            <button class="btn-icon btn-remove" (click)="removeUnit(i)" *ngIf="!unit.isDefault">‚úï</button>
          </div>
        </div>
      </div>

      <!-- Pricing -->
      <div class="form-section">
        <h3 class="section-title">Gi√° & Thu·∫ø</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>Gi√° v·ªën</label>
            <input type="number" [(ngModel)]="formData.costPrice" min="0">
          </div>
          <div class="form-group">
            <label>Gi√° b√°n</label>
            <input type="number" [(ngModel)]="formData.salePrice" min="0">
          </div>
          <div class="form-group">
            <label>Thu·∫ø GTGT</label>
            <select [(ngModel)]="formData.vatRate">
              <option *ngFor="let vat of vatRates" [value]="vat.value">{{ vat.label }}</option>
            </select>
          </div>
          <div class="form-group">
            <label>PP t√≠nh gi√° xu·∫•t</label>
            <select [(ngModel)]="formData.costingMethod">
              <option *ngFor="let m of costingMethods" [value]="m.value">{{ m.label }}</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Stock -->
      <div class="form-section">
        <h3 class="section-title">T·ªìn kho</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>T·ªìn hi·ªán t·∫°i</label>
            <input type="number" [(ngModel)]="formData.currentStock" min="0" [disabled]="isEditMode">
          </div>
          <div class="form-group">
            <label>T·ªìn t·ªëi thi·ªÉu</label>
            <input type="number" [(ngModel)]="formData.minStock" min="0">
          </div>
          <div class="form-group">
            <label>T·ªìn t·ªëi ƒëa</label>
            <input type="number" [(ngModel)]="formData.maxStock" min="0">
          </div>
        </div>
      </div>

      <!-- Accounts -->
      <div class="form-section">
        <h3 class="section-title">T√†i kho·∫£n k·∫ø to√°n</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>TK t·ªìn kho</label>
            <input type="text" [(ngModel)]="formData.inventoryAccount" placeholder="156, 155, 152, 153">
          </div>
          <div class="form-group">
            <label>TK doanh thu</label>
            <input type="text" [(ngModel)]="formData.revenueAccount" placeholder="5111">
          </div>
          <div class="form-group">
            <label>TK gi√° v·ªën</label>
            <input type="text" [(ngModel)]="formData.cogsAccount" placeholder="632">
          </div>
          <div class="form-group">
            <label>TK mua h√†ng</label>
            <input type="text" [(ngModel)]="formData.purchaseAccount" placeholder="1561">
          </div>
        </div>
      </div>

      <!-- Additional -->
      <div class="form-section">
        <h3 class="section-title">Th√¥ng tin kh√°c</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>Xu·∫•t x·ª©</label>
            <input type="text" [(ngModel)]="formData.origin">
          </div>
          <div class="form-group">
            <label>B·∫£o h√†nh</label>
            <input type="text" [(ngModel)]="formData.warranty">
          </div>
          <div class="form-group col-span-2">
            <label>Quy c√°ch</label>
            <input type="text" [(ngModel)]="formData.specifications">
          </div>
          <div class="form-group col-span-4">
            <label>M√¥ t·∫£</label>
            <textarea [(ngModel)]="formData.description" rows="2"></textarea>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeCreateModal()">H·ªßy</button>
      <button class="btn btn-primary" (click)="saveProduct()" [disabled]="loading">
        {{ loading ? 'ƒêang l∆∞u...' : (isEditMode ? 'C·∫≠p nh·∫≠t' : 'Th√™m m·ªõi') }}
      </button>
    </div>
  </div>
</div>

<!-- DETAIL MODAL -->
<div class="modal-overlay" *ngIf="showDetailModal && selectedProduct" (click)="closeDetailModal()">
  <div class="modal modal-large" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Chi ti·∫øt: {{ selectedProduct.code }} - {{ selectedProduct.name }}</h2>
      <button class="btn-close" (click)="closeDetailModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="detail-grid">
        <div class="detail-section">
          <h4>Th√¥ng tin c∆° b·∫£n</h4>
          <div class="detail-item"><label>M√£:</label><span>{{ selectedProduct.code }}</span></div>
          <div class="detail-item" *ngIf="selectedProduct.barcode"><label>Barcode:</label><span>{{ selectedProduct.barcode }}</span></div>
          <div class="detail-item"><label>T√™n:</label><span>{{ selectedProduct.name }}</span></div>
          <div class="detail-item"><label>Lo·∫°i:</label><span>{{ getProductTypeLabel(selectedProduct.productType) }}</span></div>
          <div class="detail-item"><label>Nh√≥m:</label><span>{{ getProductGroupLabel(selectedProduct.productGroup) }}</span></div>
          <div class="detail-item" *ngIf="selectedProduct.brand"><label>Th∆∞∆°ng hi·ªáu:</label><span>{{ selectedProduct.brand }}</span></div>
          <div class="detail-item" *ngIf="selectedProduct.origin"><label>Xu·∫•t x·ª©:</label><span>{{ selectedProduct.origin }}</span></div>
          <div class="detail-item"><label>Tr·∫°ng th√°i:</label><span class="status-badge" [class]="getStatusClass(selectedProduct.status)">{{ getStatusLabel(selectedProduct.status) }}</span></div>
        </div>
        <div class="detail-section">
          <h4>Gi√° & Thu·∫ø</h4>
          <div class="detail-item"><label>Gi√° v·ªën:</label><span>{{ formatCurrency(selectedProduct.costPrice) }}</span></div>
          <div class="detail-item"><label>Gi√° b√°n:</label><span>{{ formatCurrency(selectedProduct.salePrice) }}</span></div>
          <div class="detail-item"><label>VAT:</label><span>{{ getVatLabel(selectedProduct.vatRate) }}</span></div>
          <div class="detail-item"><label>PP t√≠nh gi√°:</label><span>{{ costingMethods | json }}</span></div>
        </div>
        <div class="detail-section">
          <h4>T·ªìn kho</h4>
          <div class="detail-item"><label>ƒêVT:</label><span>{{ selectedProduct.unit }}</span></div>
          <div class="detail-item"><label>T·ªìn hi·ªán t·∫°i:</label><span [class.warning]="isLowStock(selectedProduct)">{{ formatNumber(selectedProduct.currentStock) }}</span></div>
          <div class="detail-item" *ngIf="selectedProduct.minStock"><label>T·ªìn t·ªëi thi·ªÉu:</label><span>{{ formatNumber(selectedProduct.minStock) }}</span></div>
          <div class="detail-item" *ngIf="selectedProduct.maxStock"><label>T·ªìn t·ªëi ƒëa:</label><span>{{ formatNumber(selectedProduct.maxStock) }}</span></div>
          <div class="detail-item"><label>Gi√° tr·ªã t·ªìn:</label><span>{{ formatCurrency(selectedProduct.currentStock * selectedProduct.costPrice) }}</span></div>
        </div>
      </div>
      <div class="detail-section" *ngIf="selectedProduct.units && selectedProduct.units.length > 1">
        <h4>ƒê∆°n v·ªã t√≠nh quy ƒë·ªïi</h4>
        <table class="sub-table">
          <thead><tr><th>ƒêVT</th><th>T·ª∑ l·ªá</th><th>M·∫∑c ƒë·ªãnh</th></tr></thead>
          <tbody>
            <tr *ngFor="let u of selectedProduct.units">
              <td>{{ u.unit }}</td><td>{{ u.conversionRate }}</td><td>{{ u.isDefault ? '‚úì' : '' }}</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="detail-section">
        <h4>T√†i kho·∫£n k·∫ø to√°n</h4>
        <div class="account-badges">
          <span class="account-badge">TK T·ªìn kho: {{ selectedProduct.inventoryAccount }}</span>
          <span class="account-badge">TK Doanh thu: {{ selectedProduct.revenueAccount }}</span>
          <span class="account-badge">TK Gi√° v·ªën: {{ selectedProduct.cogsAccount }}</span>
          <span class="account-badge">TK Mua h√†ng: {{ selectedProduct.purchaseAccount }}</span>
        </div>
      </div>
      <div class="detail-note" *ngIf="selectedProduct.description">
        <h4>M√¥ t·∫£</h4>
        <p>{{ selectedProduct.description }}</p>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeDetailModal()">ƒê√≥ng</button>
      <button class="btn btn-primary" (click)="openEditModal(selectedProduct); closeDetailModal()">S·ª≠a</button>
    </div>
  </div>
</div>

<!-- DELETE CONFIRM -->
<div class="modal-overlay" *ngIf="showDeleteConfirm" (click)="showDeleteConfirm = false">
  <div class="modal modal-small" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>X√°c nh·∫≠n x√≥a</h2>
      <button class="btn-close" (click)="showDeleteConfirm = false">&times;</button>
    </div>
    <div class="modal-body">
      <div class="warning-message">
        <span class="warning-icon">‚ö†Ô∏è</span>
        <p>B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a h√†ng h√≥a <strong>{{ selectedProduct?.name }}</strong>?</p>
        <p class="warning-note" *ngIf="selectedProduct && selectedProduct.currentStock > 0">
          H√†ng h√≥a n√†y c√≤n t·ªìn kho {{ selectedProduct.currentStock }} {{ selectedProduct.unit }}!
        </p>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="showDeleteConfirm = false">H·ªßy</button>
      <button class="btn btn-danger" (click)="deleteProduct()">X√≥a</button>
    </div>
  </div>
</div>

<div class="loading-overlay" *ngIf="loading"><div class="spinner"></div></div>

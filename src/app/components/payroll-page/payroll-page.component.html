<div class="payroll-page">
  <!-- HEADER -->
  <div class="page-header">
    <div class="header-left">
      <h1>üìã B·∫£ng L∆∞∆°ng</h1>
      <p class="subtitle">TK 334 - Ph·∫£i tr·∫£ ng∆∞·ªùi lao ƒë·ªông</p>
    </div>
    <div class="header-actions">
      <select [(ngModel)]="filterYear" (change)="onYearChange()" class="year-select">
        <option *ngFor="let y of years" [value]="y">NƒÉm {{ y }}</option>
      </select>
      <button class="btn btn-primary" (click)="openCreateModal()">
        + T·∫°o b·∫£ng l∆∞∆°ng
      </button>
    </div>
  </div>

  <!-- SUMMARY CARDS -->
  <div class="summary-cards">
    <div class="card total-employees">
      <div class="card-icon">üë•</div>
      <div class="card-content">
        <span class="card-value">{{ payrolls.length }}</span>
        <span class="card-label">B·∫£ng l∆∞∆°ng</span>
      </div>
    </div>
    <div class="card total-gross">
      <div class="card-icon">üí∞</div>
      <div class="card-content">
        <span class="card-value">{{ formatCurrency(getTotalGross()) }}</span>
        <span class="card-label">T·ªïng thu nh·∫≠p</span>
      </div>
    </div>
    <div class="card total-deductions">
      <div class="card-icon">üìâ</div>
      <div class="card-content">
        <span class="card-value">{{ formatCurrency(getTotalDeductions()) }}</span>
        <span class="card-label">T·ªïng kh·∫•u tr·ª´</span>
      </div>
    </div>
    <div class="card total-net">
      <div class="card-icon">üíµ</div>
      <div class="card-content">
        <span class="card-value">{{ formatCurrency(getTotalNet()) }}</span>
        <span class="card-label">T·ªïng th·ª±c lƒ©nh</span>
      </div>
    </div>
  </div>

  <!-- PAYROLL LIST -->
  <div class="payroll-list">
    <div class="list-header">
      <h2>Danh s√°ch b·∫£ng l∆∞∆°ng nƒÉm {{ filterYear }}</h2>
    </div>

    <div class="table-container">
      <table class="data-table">
        <thead>
          <tr>
            <th class="col-month">Th√°ng</th>
            <th class="col-no">S·ªë b·∫£ng l∆∞∆°ng</th>
            <th class="col-count">S·ªë NV</th>
            <th class="col-gross">T·ªïng thu nh·∫≠p</th>
            <th class="col-insurance">BH NLƒê</th>
            <th class="col-pit">Thu·∫ø TNCN</th>
            <th class="col-net">Th·ª±c lƒ©nh</th>
            <th class="col-status">Tr·∫°ng th√°i</th>
            <th class="col-actions">Thao t√°c</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let payroll of payrolls"
              [class.row-cancelled]="payroll.status === 'CANCELLED'"
              (click)="viewPayroll(payroll)">
            <td class="col-month">
              <strong>{{ getMonthLabel(payroll.month) }}</strong>
            </td>
            <td class="col-no">{{ payroll.payrollNo }}</td>
            <td class="col-count">{{ payroll.summary.employeeCount }}</td>
            <td class="col-gross amount">{{ formatCurrency(payroll.summary.totalGrossSalary) }}</td>
            <td class="col-insurance amount">{{ formatCurrency(payroll.summary.totalInsuranceDeduction) }}</td>
            <td class="col-pit amount">{{ formatCurrency(payroll.summary.totalPIT) }}</td>
            <td class="col-net amount highlight">{{ formatCurrency(payroll.summary.totalNetSalary) }}</td>
            <td class="col-status">
              <span class="status-badge" [ngClass]="getStatusClass(payroll.status)">
                {{ getStatusLabel(payroll.status) }}
              </span>
            </td>
            <td class="col-actions" (click)="$event.stopPropagation()">
              <button class="btn-icon" title="Xem chi ti·∫øt" (click)="viewPayroll(payroll)">üëÅÔ∏è</button>
              <button class="btn-icon" title="X√≥a"
                      *ngIf="payroll.status === 'DRAFT'"
                      (click)="deletePayroll(payroll.id)">üóëÔ∏è</button>
            </td>
          </tr>
          <tr *ngIf="payrolls.length === 0">
            <td colspan="9" class="empty-row">
              Ch∆∞a c√≥ b·∫£ng l∆∞∆°ng n√†o trong nƒÉm {{ filterYear }}
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- CREATE MODAL -->
  <div class="modal-overlay" *ngIf="showCreateModal" (click)="closeCreateModal()">
    <div class="modal create-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>T·∫°o b·∫£ng l∆∞∆°ng m·ªõi</h2>
        <button class="btn-close" (click)="closeCreateModal()">√ó</button>
      </div>

      <div class="modal-body">
        <!-- Period Selection -->
        <div class="period-selection">
          <div class="form-group">
            <label>Th√°ng</label>
            <select [(ngModel)]="newMonth">
              <option *ngFor="let m of getMonths()" [value]="m">{{ getMonthLabel(m) }}</option>
            </select>
          </div>
          <div class="form-group">
            <label>NƒÉm</label>
            <select [(ngModel)]="newYear">
              <option *ngFor="let y of years" [value]="y">{{ y }}</option>
            </select>
          </div>
        </div>

        <!-- Employee List -->
        <div class="employee-list">
          <h3>Danh s√°ch nh√¢n vi√™n ({{ newLines.length }} ng∆∞·ªùi)</h3>

          <div class="table-container">
            <table class="data-table compact">
              <thead>
                <tr>
                  <th>M√£ NV</th>
                  <th>H·ªç t√™n</th>
                  <th>Ph√≤ng ban</th>
                  <th>Ng√†y c√¥ng</th>
                  <th>L∆∞∆°ng CB</th>
                  <th>Ph·ª• c·∫•p</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let line of newLines; let i = index">
                  <td>{{ line.employeeCode }}</td>
                  <td>{{ line.employeeName }}</td>
                  <td>{{ line.department }}</td>
                  <td>
                    <input type="number" [(ngModel)]="line.workingDays"
                           min="0" max="31" class="input-days">
                  </td>
                  <td class="amount">{{ formatCurrency(line.baseSalary || 0) }}</td>
                  <td class="amount">{{ formatCurrency(getTotalAllowance(line)) }}</td>
                  <td>
                    <button class="btn-icon small" (click)="removeEmployeeFromNew(i)">√ó</button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeCreateModal()">H·ªßy</button>
        <button class="btn btn-primary" (click)="createPayroll()"
                [disabled]="newLines.length === 0">
          T·∫°o b·∫£ng l∆∞∆°ng
        </button>
      </div>
    </div>
  </div>

  <!-- DETAIL MODAL -->
  <div class="modal-overlay" *ngIf="showDetailModal" (click)="closeDetailModal()">
    <div class="modal detail-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div>
          <h2>{{ editingPayroll?.payrollNo }} - Th√°ng {{ editingPayroll?.month }}/{{ editingPayroll?.year }}</h2>
          <span class="status-badge" [ngClass]="getStatusClass(editingPayroll?.status || 'DRAFT')">
            {{ getStatusLabel(editingPayroll?.status || 'DRAFT') }}
          </span>
        </div>
        <div class="header-actions">
          <button class="btn btn-secondary" (click)="print()">üñ®Ô∏è In</button>
          <button class="btn btn-secondary" (click)="exportToExcel()">üìä Excel</button>
          <button class="btn-close" (click)="closeDetailModal()">√ó</button>
        </div>
      </div>

      <div class="modal-body" *ngIf="editingPayroll">
        <!-- Summary -->
        <div class="payroll-summary">
          <div class="summary-item">
            <span class="label">S·ªë nh√¢n vi√™n:</span>
            <span class="value">{{ editingPayroll.summary.employeeCount }}</span>
          </div>
          <div class="summary-item">
            <span class="label">T·ªïng ng√†y c√¥ng:</span>
            <span class="value">{{ editingPayroll.summary.totalWorkingDays }}</span>
          </div>
          <div class="summary-item highlight">
            <span class="label">T·ªïng thu nh·∫≠p:</span>
            <span class="value">{{ formatCurrency(editingPayroll.summary.totalGrossSalary) }}</span>
          </div>
          <div class="summary-item">
            <span class="label">BH NLƒê ƒë√≥ng:</span>
            <span class="value negative">-{{ formatCurrency(editingPayroll.summary.totalInsuranceDeduction) }}</span>
          </div>
          <div class="summary-item">
            <span class="label">Thu·∫ø TNCN:</span>
            <span class="value negative">-{{ formatCurrency(editingPayroll.summary.totalPIT) }}</span>
          </div>
          <div class="summary-item primary">
            <span class="label">Th·ª±c lƒ©nh:</span>
            <span class="value">{{ formatCurrency(editingPayroll.summary.totalNetSalary) }}</span>
          </div>
        </div>

        <!-- Detail Table -->
        <div class="detail-table-container">
          <table class="data-table detail-table">
            <thead>
              <tr>
                <th rowspan="2" class="sticky-col">STT</th>
                <th rowspan="2" class="sticky-col">M√£ NV</th>
                <th rowspan="2" class="sticky-col">H·ªç v√† t√™n</th>
                <th rowspan="2">Ph√≤ng ban</th>
                <th rowspan="2">Ng√†y c√¥ng</th>
                <th colspan="3" class="group-header">Thu nh·∫≠p</th>
                <th colspan="3" class="group-header">Kh·∫•u tr·ª´ NLƒê</th>
                <th rowspan="2" class="highlight-col">Th·ª±c lƒ©nh</th>
              </tr>
              <tr>
                <th>L∆∞∆°ng TT</th>
                <th>Ph·ª• c·∫•p</th>
                <th>T·ªïng TN</th>
                <th>BHXH/YT/TN</th>
                <th>Thu·∫ø TNCN</th>
                <th>Kh√°c</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let line of editingPayroll.lines; let i = index">
                <td class="sticky-col center">{{ i + 1 }}</td>
                <td class="sticky-col">{{ line.employeeCode }}</td>
                <td class="sticky-col name">{{ line.employeeName }}</td>
                <td>{{ line.department }}</td>
                <td class="center">{{ line.workingDays }}/{{ line.standardDays }}</td>
                <td class="amount">{{ formatCurrency(line.actualSalary) }}</td>
                <td class="amount">{{ formatCurrency(line.totalAllowances) }}</td>
                <td class="amount">{{ formatCurrency(line.grossSalary) }}</td>
                <td class="amount negative">{{ formatCurrency(line.totalInsuranceDeduction) }}</td>
                <td class="amount negative">{{ formatCurrency(line.pitAmount) }}</td>
                <td class="amount negative">{{ formatCurrency(line.totalOtherDeductions) }}</td>
                <td class="amount highlight">{{ formatCurrency(line.netSalary) }}</td>
              </tr>
            </tbody>
            <tfoot>
              <tr class="total-row">
                <td colspan="4" class="sticky-col"><strong>T·ªîNG C·ªòNG</strong></td>
                <td class="center"><strong>{{ editingPayroll.summary.totalWorkingDays }}</strong></td>
                <td class="amount"><strong>{{ formatCurrency(editingPayroll.summary.totalBaseSalary) }}</strong></td>
                <td class="amount"><strong>{{ formatCurrency(editingPayroll.summary.totalAllowances) }}</strong></td>
                <td class="amount"><strong>{{ formatCurrency(editingPayroll.summary.totalGrossSalary) }}</strong></td>
                <td class="amount negative"><strong>{{ formatCurrency(editingPayroll.summary.totalInsuranceDeduction) }}</strong></td>
                <td class="amount negative"><strong>{{ formatCurrency(editingPayroll.summary.totalPIT) }}</strong></td>
                <td class="amount negative"><strong>{{ formatCurrency(editingPayroll.summary.totalOtherDeductions) }}</strong></td>
                <td class="amount highlight"><strong>{{ formatCurrency(editingPayroll.summary.totalNetSalary) }}</strong></td>
              </tr>
            </tfoot>
          </table>
        </div>

        <!-- Company Cost Summary -->
        <div class="company-cost">
          <h3>Chi ph√≠ c√¥ng ty</h3>
          <div class="cost-items">
            <div class="cost-item">
              <span>BH c√¥ng ty ƒë√≥ng (22%):</span>
              <span class="value">{{ formatCurrency(editingPayroll.summary.totalCompanyInsurance) }}</span>
            </div>
            <div class="cost-item total">
              <span>T·ªïng chi ph√≠ lao ƒë·ªông:</span>
              <span class="value">{{ formatCurrency(editingPayroll.summary.totalLaborCost) }}</span>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <div class="footer-left">
          <span *ngIf="editingPayroll?.approvedAt">
            Duy·ªát: {{ formatDate(editingPayroll?.approvedAt) }} b·ªüi {{ editingPayroll?.approvedBy }}
          </span>
          <span *ngIf="editingPayroll?.paidAt">
            | Chi: {{ formatDate(editingPayroll?.paidAt) }}
          </span>
        </div>
        <div class="footer-right">
          <button class="btn btn-secondary" (click)="closeDetailModal()">ƒê√≥ng</button>

          <ng-container *ngIf="editingPayroll?.status === 'DRAFT'">
            <button class="btn btn-primary" (click)="savePayroll()">üíæ L∆∞u</button>
            <button class="btn btn-success" (click)="approvePayroll(editingPayroll!.id)">‚úÖ Duy·ªát</button>
          </ng-container>

          <ng-container *ngIf="editingPayroll?.status === 'APPROVED'">
            <button class="btn btn-success" (click)="markAsPaid(editingPayroll!.id)">üí∞ X√°c nh·∫≠n chi</button>
            <button class="btn btn-danger" (click)="cancelPayroll(editingPayroll!.id)">‚ùå H·ªßy</button>
          </ng-container>
        </div>
      </div>
    </div>
  </div>

  <!-- LOADING -->
  <div class="loading-overlay" *ngIf="isLoading">
    <div class="spinner"></div>
  </div>
</div>

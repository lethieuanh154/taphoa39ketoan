<div class="other-voucher-page">
  <!-- HEADER -->
  <div class="page-header">
    <div>
      <h1 class="page-title">Ch·ª©ng T·ª´ Kh√°c</h1>
      <p class="page-subtitle">B√∫t to√°n ƒëi·ªÅu ch·ªânh, k·∫øt chuy·ªÉn, kh·∫•u hao, ph√¢n b·ªï</p>
    </div>
    <div class="header-actions">
      <button class="btn btn-primary" (click)="openCreateModal()">
        <span class="icon">‚ûï</span> T·∫°o ch·ª©ng t·ª´
      </button>
    </div>
  </div>

  <!-- SUMMARY CARDS -->
  <div class="summary-cards">
    <div class="summary-card card-total">
      <div class="card-icon">üìù</div>
      <div class="card-content">
        <span class="card-label">T·ªïng ch·ª©ng t·ª´</span>
        <span class="card-value">{{ stats.total }}</span>
      </div>
    </div>
    <div class="summary-card card-draft">
      <div class="card-icon">üìã</div>
      <div class="card-content">
        <span class="card-label">Nh√°p</span>
        <span class="card-value text-orange">{{ stats.draft }}</span>
      </div>
    </div>
    <div class="summary-card card-posted">
      <div class="card-icon">‚úÖ</div>
      <div class="card-content">
        <span class="card-label">ƒê√£ ghi s·ªï</span>
        <span class="card-value text-green">{{ stats.posted }}</span>
      </div>
    </div>
    <div class="summary-card card-amount">
      <div class="card-icon">üí∞</div>
      <div class="card-content">
        <span class="card-label">T·ªïng PS (N·ª£)</span>
        <span class="card-value">{{ formatCurrency(stats.totalAmount) }}</span>
      </div>
    </div>
  </div>

  <!-- FILTER SECTION -->
  <div class="filter-section">
    <div class="filter-row">
      <div class="filter-group filter-search">
        <label>T√¨m ki·∫øm</label>
        <input type="text" [(ngModel)]="searchText" (input)="onSearch()"
               placeholder="S·ªë ch·ª©ng t·ª´, di·ªÖn gi·∫£i...">
      </div>
      <div class="filter-group">
        <label>Lo·∫°i ch·ª©ng t·ª´</label>
        <select [(ngModel)]="filter.voucherType" (change)="onFilterChange()">
          <option [ngValue]="undefined">T·∫•t c·∫£</option>
          <option *ngFor="let t of voucherTypes" [value]="t.value">{{ t.label }}</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Tr·∫°ng th√°i</label>
        <select [(ngModel)]="filter.status" (change)="onFilterChange()">
          <option [ngValue]="undefined">T·∫•t c·∫£</option>
          <option *ngFor="let s of voucherStatuses" [value]="s.value">{{ s.label }}</option>
        </select>
      </div>
      <button class="btn btn-secondary btn-sm" (click)="clearFilters()">X√≥a l·ªçc</button>
    </div>
  </div>

  <!-- VOUCHERS TABLE -->
  <div class="table-container">
    <table class="data-table">
      <thead>
        <tr>
          <th class="col-no">STT</th>
          <th class="col-date">Ng√†y CT</th>
          <th class="col-voucher">S·ªë ch·ª©ng t·ª´</th>
          <th class="col-type">Lo·∫°i</th>
          <th class="col-desc">Di·ªÖn gi·∫£i</th>
          <th class="col-amount text-right">N·ª£</th>
          <th class="col-amount text-right">C√≥</th>
          <th class="col-status">Tr·∫°ng th√°i</th>
          <th class="col-actions">Thao t√°c</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let v of filteredVouchers; let i = index" [class.cancelled-row]="v.status === 'CANCELLED'">
          <td>{{ i + 1 }}</td>
          <td>{{ formatDate(v.voucherDate) }}</td>
          <td><span class="voucher-no">{{ v.voucherNo }}</span></td>
          <td><span class="type-badge type-{{ v.voucherType.toLowerCase() }}">{{ getVoucherTypeLabel(v.voucherType) }}</span></td>
          <td class="desc-cell">{{ v.description }}</td>
          <td class="text-right">{{ formatCurrency(v.totalDebit) }}</td>
          <td class="text-right">{{ formatCurrency(v.totalCredit) }}</td>
          <td>
            <span class="status-badge" [ngClass]="getStatusClass(v.status)">
              {{ getStatusLabel(v.status) }}
            </span>
          </td>
          <td>
            <div class="action-buttons">
              <button class="btn-icon btn-view" title="Xem" (click)="openViewModal(v)">üëÅ</button>
              <button class="btn-icon btn-edit" title="S·ª≠a" *ngIf="v.status === 'DRAFT'" (click)="openEditModal(v)">‚úèÔ∏è</button>
              <button class="btn-icon btn-post" title="Ghi s·ªï" *ngIf="v.status === 'DRAFT'" (click)="postVoucher(v)">üìó</button>
              <button class="btn-icon btn-cancel" title="H·ªßy" *ngIf="v.status === 'POSTED'" (click)="cancelVoucher(v)">üö´</button>
              <button class="btn-icon btn-delete" title="X√≥a" *ngIf="v.status === 'DRAFT'" (click)="deleteVoucher(v)">üóëÔ∏è</button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Empty State -->
    <div class="empty-state" *ngIf="filteredVouchers.length === 0 && !isLoading">
      <div class="empty-icon">üìù</div>
      <p>Ch∆∞a c√≥ ch·ª©ng t·ª´ n√†o</p>
      <button class="btn btn-primary" (click)="openCreateModal()">T·∫°o ch·ª©ng t·ª´ ƒë·∫ßu ti√™n</button>
    </div>
  </div>

  <!-- MODAL -->
  <div class="modal-overlay" *ngIf="showModal" (click)="closeModal()">
    <div class="modal-content modal-lg" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>
          {{ modalMode === 'create' ? 'T·∫°o ch·ª©ng t·ª´ m·ªõi' :
             modalMode === 'edit' ? 'Ch·ªânh s·ª≠a ch·ª©ng t·ª´' : 'Chi ti·∫øt ch·ª©ng t·ª´' }}
        </h2>
        <button class="btn-close" (click)="closeModal()">‚úï</button>
      </div>

      <div class="modal-body">
        <!-- Validation Errors -->
        <div class="validation-errors" *ngIf="validationErrors.length > 0">
          <p *ngFor="let err of validationErrors">‚ö†Ô∏è {{ err }}</p>
        </div>

        <!-- Header Info -->
        <div class="form-section">
          <div class="form-row">
            <div class="form-group">
              <label>Lo·∫°i ch·ª©ng t·ª´ <span class="required">*</span></label>
              <select [(ngModel)]="editingVoucher.voucherType" [disabled]="modalMode === 'view'">
                <option *ngFor="let t of voucherTypes" [value]="t.value">{{ t.label }}</option>
              </select>
            </div>
            <div class="form-group">
              <label>Ng√†y ch·ª©ng t·ª´ <span class="required">*</span></label>
              <input type="date" [ngModel]="editingVoucher.voucherDate | date:'yyyy-MM-dd'"
                     (ngModelChange)="onDateChange('voucherDate', $event)" [disabled]="modalMode === 'view'">
            </div>
            <div class="form-group">
              <label>S·ªë ch·ª©ng t·ª´</label>
              <input type="text" [(ngModel)]="editingVoucher.voucherNo" [disabled]="modalMode === 'view'"
                     placeholder="T·ª± ƒë·ªông">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group full-width">
              <label>Di·ªÖn gi·∫£i <span class="required">*</span></label>
              <input type="text" [(ngModel)]="editingVoucher.description" [disabled]="modalMode === 'view'"
                     placeholder="N·ªôi dung b√∫t to√°n">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group full-width">
              <label>L√Ω do</label>
              <input type="text" [(ngModel)]="editingVoucher.reason" [disabled]="modalMode === 'view'">
            </div>
          </div>
        </div>

        <!-- Entries -->
        <div class="form-section">
          <div class="section-header">
            <h4>Chi ti·∫øt b√∫t to√°n</h4>
            <button class="btn btn-secondary btn-sm" *ngIf="modalMode !== 'view'" (click)="addEntry()">
              ‚ûï Th√™m d√≤ng
            </button>
          </div>

          <table class="entry-table">
            <thead>
              <tr>
                <th class="col-line">#</th>
                <th class="col-account">T√†i kho·∫£n</th>
                <th class="col-entry-desc">Di·ªÖn gi·∫£i</th>
                <th class="col-entry-debit text-right">N·ª£</th>
                <th class="col-entry-credit text-right">C√≥</th>
                <th class="col-entry-action" *ngIf="modalMode !== 'view'"></th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let entry of editingVoucher.entries; let i = index">
                <td>{{ entry.lineNo }}</td>
                <td>
                  <input type="text" [(ngModel)]="entry.accountCode" [disabled]="modalMode === 'view'"
                         placeholder="111" class="input-sm">
                </td>
                <td>
                  <input type="text" [(ngModel)]="entry.description" [disabled]="modalMode === 'view'"
                         placeholder="Di·ªÖn gi·∫£i" class="input-full">
                </td>
                <td>
                  <input type="number" [(ngModel)]="entry.debitAmount" [disabled]="modalMode === 'view'"
                         class="input-sm text-right">
                </td>
                <td>
                  <input type="number" [(ngModel)]="entry.creditAmount" [disabled]="modalMode === 'view'"
                         class="input-sm text-right">
                </td>
                <td *ngIf="modalMode !== 'view'">
                  <button class="btn-icon btn-delete" (click)="removeEntry(i)"
                          [disabled]="editingVoucher.entries!.length <= 1">üóëÔ∏è</button>
                </td>
              </tr>
            </tbody>
            <tfoot>
              <tr class="total-row">
                <td colspan="3"><strong>T·ªïng c·ªông</strong></td>
                <td class="text-right"><strong>{{ formatCurrency(getTotals().totalDebit) }}</strong></td>
                <td class="text-right"><strong>{{ formatCurrency(getTotals().totalCredit) }}</strong></td>
                <td *ngIf="modalMode !== 'view'"></td>
              </tr>
              <tr class="balance-row" [class.balanced]="getTotals().balanced" [class.unbalanced]="!getTotals().balanced">
                <td colspan="6">
                  <span *ngIf="getTotals().balanced">‚úÖ B√∫t to√°n c√¢n ƒë·ªëi</span>
                  <span *ngIf="!getTotals().balanced">‚ö†Ô∏è B√∫t to√°n KH√îNG c√¢n ƒë·ªëi (ch√™nh l·ªách: {{ formatCurrency(getBalanceDiff()) }})</span>
                </td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>

      <div class="modal-footer" *ngIf="modalMode !== 'view'">
        <button class="btn btn-secondary" (click)="closeModal()">H·ªßy</button>
        <button class="btn btn-primary" (click)="saveVoucher()" [disabled]="!getTotals().balanced">
          {{ modalMode === 'create' ? 'T·∫°o m·ªõi' : 'C·∫≠p nh·∫≠t' }}
        </button>
      </div>
      <div class="modal-footer" *ngIf="modalMode === 'view'">
        <button class="btn btn-secondary" (click)="closeModal()">ƒê√≥ng</button>
        <button class="btn btn-primary" *ngIf="editingVoucher.status === 'DRAFT'" (click)="modalMode = 'edit'">Ch·ªânh s·ª≠a</button>
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div class="loading-overlay" *ngIf="isLoading">
    <div class="spinner"></div>
  </div>
</div>

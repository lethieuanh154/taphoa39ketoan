<div class="employee-page">
  <!-- HEADER -->
  <div class="page-header">
    <div>
      <h1 class="page-title">Danh M·ª•c Nh√¢n Vi√™n</h1>
      <p class="page-subtitle">Qu·∫£n l√Ω th√¥ng tin nh√¢n vi√™n, h·ª£p ƒë·ªìng, b·∫£o hi·ªÉm</p>
    </div>
    <div class="header-actions">
      <button class="btn btn-primary" (click)="openCreateModal()">
        <span class="icon">‚ûï</span> Th√™m nh√¢n vi√™n
      </button>
    </div>
  </div>

  <!-- SUMMARY CARDS -->
  <div class="summary-cards">
    <div class="summary-card card-total">
      <div class="card-icon">üë•</div>
      <div class="card-content">
        <span class="card-label">T·ªïng nh√¢n vi√™n</span>
        <span class="card-value">{{ stats.total }}</span>
      </div>
    </div>
    <div class="summary-card card-working">
      <div class="card-icon">‚úÖ</div>
      <div class="card-content">
        <span class="card-label">ƒêang l√†m vi·ªác</span>
        <span class="card-value text-green">{{ stats.working }}</span>
      </div>
    </div>
    <div class="summary-card card-leave">
      <div class="card-icon">üèñÔ∏è</div>
      <div class="card-content">
        <span class="card-label">Ngh·ªâ ph√©p/thai s·∫£n</span>
        <span class="card-value text-orange">{{ stats.onLeave }}</span>
      </div>
    </div>
    <div class="summary-card card-salary">
      <div class="card-icon">üí∞</div>
      <div class="card-content">
        <span class="card-label">T·ªïng qu·ªπ l∆∞∆°ng</span>
        <span class="card-value">{{ formatCurrency(stats.totalSalary) }}</span>
      </div>
    </div>
    <div class="summary-card card-avg">
      <div class="card-icon">üìä</div>
      <div class="card-content">
        <span class="card-label">L∆∞∆°ng TB</span>
        <span class="card-value">{{ formatCurrency(stats.avgSalary) }}</span>
      </div>
    </div>
  </div>

  <!-- FILTER SECTION -->
  <div class="filter-section">
    <div class="filter-row">
      <div class="filter-group filter-search">
        <label>T√¨m ki·∫øm</label>
        <input type="text" [(ngModel)]="searchText" (input)="onSearch()"
               placeholder="M√£ NV, h·ªç t√™n, SƒêT, ch·ª©c v·ª•...">
      </div>
      <div class="filter-group">
        <label>Tr·∫°ng th√°i</label>
        <select [(ngModel)]="filter.status" (change)="onFilterChange()">
          <option [ngValue]="undefined">T·∫•t c·∫£</option>
          <option *ngFor="let s of employeeStatuses" [value]="s.value">{{ s.label }}</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Lo·∫°i NV</label>
        <select [(ngModel)]="filter.employeeType" (change)="onFilterChange()">
          <option [ngValue]="undefined">T·∫•t c·∫£</option>
          <option *ngFor="let t of employeeTypes" [value]="t.value">{{ t.label }}</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Lo·∫°i Hƒê</label>
        <select [(ngModel)]="filter.contractType" (change)="onFilterChange()">
          <option [ngValue]="undefined">T·∫•t c·∫£</option>
          <option *ngFor="let c of contractTypes" [value]="c.value">{{ c.label }}</option>
        </select>
      </div>
      <button class="btn btn-secondary btn-sm" (click)="clearFilters()">X√≥a l·ªçc</button>
    </div>
  </div>

  <!-- EMPLOYEE TABLE -->
  <div class="table-container">
    <table class="data-table">
      <thead>
        <tr>
          <th class="col-no">STT</th>
          <th class="col-code">M√£ NV</th>
          <th class="col-name">H·ªç t√™n</th>
          <th class="col-phone">ƒêi·ªán tho·∫°i</th>
          <th class="col-dept">Ph√≤ng ban</th>
          <th class="col-position">Ch·ª©c v·ª•</th>
          <th class="col-salary text-right">L∆∞∆°ng c∆° b·∫£n</th>
          <th class="col-status">Tr·∫°ng th√°i</th>
          <th class="col-actions">Thao t√°c</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let emp of filteredEmployees; let i = index">
          <td>{{ i + 1 }}</td>
          <td><span class="emp-code">{{ emp.code }}</span></td>
          <td>
            <div class="emp-info">
              <span class="emp-name">{{ emp.fullName }}</span>
              <span class="emp-email">{{ emp.email }}</span>
            </div>
          </td>
          <td>{{ emp.phone }}</td>
          <td>{{ emp.departmentName || '-' }}</td>
          <td>{{ emp.position }}</td>
          <td class="text-right">{{ formatCurrency(emp.baseSalary) }}</td>
          <td>
            <span class="status-badge" [ngClass]="getStatusClass(emp.status)">
              {{ getStatusLabel(emp.status) }}
            </span>
          </td>
          <td>
            <div class="action-buttons">
              <button class="btn-icon btn-view" title="Xem" (click)="openViewModal(emp)">üëÅ</button>
              <button class="btn-icon btn-edit" title="S·ª≠a" (click)="openEditModal(emp)">‚úèÔ∏è</button>
              <button class="btn-icon btn-delete" title="X√≥a" (click)="deleteEmployee(emp)">üóëÔ∏è</button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Empty State -->
    <div class="empty-state" *ngIf="filteredEmployees.length === 0 && !isLoading">
      <div class="empty-icon">üë•</div>
      <p>Kh√¥ng c√≥ nh√¢n vi√™n n√†o</p>
      <button class="btn btn-primary" (click)="openCreateModal()">Th√™m nh√¢n vi√™n ƒë·∫ßu ti√™n</button>
    </div>
  </div>

  <!-- MODAL -->
  <div class="modal-overlay" *ngIf="showModal" (click)="closeModal()">
    <div class="modal-content modal-lg" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>
          {{ modalMode === 'create' ? 'Th√™m nh√¢n vi√™n m·ªõi' :
             modalMode === 'edit' ? 'Ch·ªânh s·ª≠a nh√¢n vi√™n' : 'Th√¥ng tin nh√¢n vi√™n' }}
        </h2>
        <button class="btn-close" (click)="closeModal()">‚úï</button>
      </div>

      <!-- Tab Navigation -->
      <div class="modal-tabs">
        <button class="tab-btn" [class.active]="activeTab === 'info'" (click)="setTab('info')">Th√¥ng tin c√° nh√¢n</button>
        <button class="tab-btn" [class.active]="activeTab === 'work'" (click)="setTab('work')">C√¥ng vi·ªác</button>
        <button class="tab-btn" [class.active]="activeTab === 'salary'" (click)="setTab('salary')">L∆∞∆°ng & Ph·ª• thu·ªôc</button>
        <button class="tab-btn" [class.active]="activeTab === 'insurance'" (click)="setTab('insurance')">B·∫£o hi·ªÉm</button>
        <button class="tab-btn" [class.active]="activeTab === 'bank'" (click)="setTab('bank')">Ng√¢n h√†ng</button>
      </div>

      <div class="modal-body">
        <!-- Validation Errors -->
        <div class="validation-errors" *ngIf="validationErrors.length > 0">
          <p *ngFor="let err of validationErrors">‚ö†Ô∏è {{ err }}</p>
        </div>

        <!-- Tab: Th√¥ng tin c√° nh√¢n -->
        <div class="tab-content" *ngIf="activeTab === 'info'">
          <div class="form-row">
            <div class="form-group">
              <label>M√£ nh√¢n vi√™n <span class="required">*</span></label>
              <input type="text" [(ngModel)]="editingEmployee.code" [disabled]="modalMode === 'view'"
                     placeholder="NV0001">
            </div>
            <div class="form-group">
              <label>H·ªç v√† t√™n <span class="required">*</span></label>
              <input type="text" [(ngModel)]="editingEmployee.fullName" [disabled]="modalMode === 'view'"
                     placeholder="Nguy·ªÖn VƒÉn A">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Gi·ªõi t√≠nh</label>
              <select [(ngModel)]="editingEmployee.gender" [disabled]="modalMode === 'view'">
                <option *ngFor="let g of genders" [value]="g.value">{{ g.label }}</option>
              </select>
            </div>
            <div class="form-group">
              <label>Ng√†y sinh</label>
              <input type="date" [ngModel]="editingEmployee.dateOfBirth | date:'yyyy-MM-dd'"
                     (ngModelChange)="onDateChange('dateOfBirth', $event)" [disabled]="modalMode === 'view'">
            </div>
            <div class="form-group">
              <label>N∆°i sinh</label>
              <input type="text" [(ngModel)]="editingEmployee.placeOfBirth" [disabled]="modalMode === 'view'">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>CMND/CCCD <span class="required">*</span></label>
              <input type="text" [(ngModel)]="editingEmployee.idNumber" [disabled]="modalMode === 'view'"
                     placeholder="001234567890">
            </div>
            <div class="form-group">
              <label>Ng√†y c·∫•p</label>
              <input type="date" [ngModel]="editingEmployee.idIssueDate | date:'yyyy-MM-dd'"
                     (ngModelChange)="onDateChange('idIssueDate', $event)" [disabled]="modalMode === 'view'">
            </div>
            <div class="form-group">
              <label>N∆°i c·∫•p</label>
              <input type="text" [(ngModel)]="editingEmployee.idIssuePlace" [disabled]="modalMode === 'view'">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>M√£ s·ªë thu·∫ø c√° nh√¢n</label>
              <input type="text" [(ngModel)]="editingEmployee.taxCode" [disabled]="modalMode === 'view'">
            </div>
            <div class="form-group">
              <label>S·ªë ƒëi·ªán tho·∫°i <span class="required">*</span></label>
              <input type="text" [(ngModel)]="editingEmployee.phone" [disabled]="modalMode === 'view'"
                     placeholder="0901234567">
            </div>
            <div class="form-group">
              <label>Email</label>
              <input type="email" [(ngModel)]="editingEmployee.email" [disabled]="modalMode === 'view'">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group full-width">
              <label>ƒê·ªãa ch·ªâ hi·ªán t·∫°i</label>
              <input type="text" [(ngModel)]="editingEmployee.address" [disabled]="modalMode === 'view'">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group full-width">
              <label>ƒê·ªãa ch·ªâ th∆∞·ªùng tr√∫</label>
              <input type="text" [(ngModel)]="editingEmployee.permanentAddress" [disabled]="modalMode === 'view'">
            </div>
          </div>
        </div>

        <!-- Tab: C√¥ng vi·ªác -->
        <div class="tab-content" *ngIf="activeTab === 'work'">
          <div class="form-row">
            <div class="form-group">
              <label>Ph√≤ng ban</label>
              <input type="text" [(ngModel)]="editingEmployee.departmentName" [disabled]="modalMode === 'view'"
                     placeholder="K·∫ø to√°n">
            </div>
            <div class="form-group">
              <label>Ch·ª©c v·ª• <span class="required">*</span></label>
              <input type="text" [(ngModel)]="editingEmployee.position" [disabled]="modalMode === 'view'"
                     placeholder="K·∫ø to√°n vi√™n">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Lo·∫°i nh√¢n vi√™n</label>
              <select [(ngModel)]="editingEmployee.employeeType" [disabled]="modalMode === 'view'">
                <option *ngFor="let t of employeeTypes" [value]="t.value">{{ t.label }}</option>
              </select>
            </div>
            <div class="form-group">
              <label>Lo·∫°i h·ª£p ƒë·ªìng</label>
              <select [(ngModel)]="editingEmployee.contractType" [disabled]="modalMode === 'view'">
                <option *ngFor="let c of contractTypes" [value]="c.value">{{ c.label }}</option>
              </select>
            </div>
            <div class="form-group">
              <label>Tr·∫°ng th√°i</label>
              <select [(ngModel)]="editingEmployee.status" [disabled]="modalMode === 'view'">
                <option *ngFor="let s of employeeStatuses" [value]="s.value">{{ s.label }}</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Ng√†y v√†o l√†m <span class="required">*</span></label>
              <input type="date" [ngModel]="editingEmployee.hireDate | date:'yyyy-MM-dd'"
                     (ngModelChange)="onDateChange('hireDate', $event)" [disabled]="modalMode === 'view'">
            </div>
            <div class="form-group">
              <label>Ng√†y b·∫Øt ƒë·∫ßu Hƒê</label>
              <input type="date" [ngModel]="editingEmployee.contractStartDate | date:'yyyy-MM-dd'"
                     (ngModelChange)="onDateChange('contractStartDate', $event)" [disabled]="modalMode === 'view'">
            </div>
            <div class="form-group">
              <label>Ng√†y k·∫øt th√∫c Hƒê</label>
              <input type="date" [ngModel]="editingEmployee.contractEndDate | date:'yyyy-MM-dd'"
                     (ngModelChange)="onDateChange('contractEndDate', $event)" [disabled]="modalMode === 'view'">
            </div>
          </div>
          <div class="form-row" *ngIf="editingEmployee.status === 'RESIGNED'">
            <div class="form-group">
              <label>Ng√†y ngh·ªâ vi·ªác</label>
              <input type="date" [ngModel]="editingEmployee.resignDate | date:'yyyy-MM-dd'"
                     (ngModelChange)="onDateChange('resignDate', $event)" [disabled]="modalMode === 'view'">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group full-width">
              <label>Ghi ch√∫</label>
              <textarea [(ngModel)]="editingEmployee.notes" [disabled]="modalMode === 'view'" rows="3"></textarea>
            </div>
          </div>
        </div>

        <!-- Tab: L∆∞∆°ng & Ph·ª• thu·ªôc -->
        <div class="tab-content" *ngIf="activeTab === 'salary'">
          <h4>Th√¥ng tin l∆∞∆°ng</h4>
          <div class="form-row">
            <div class="form-group">
              <label>L∆∞∆°ng c∆° b·∫£n</label>
              <input type="number" [(ngModel)]="editingEmployee.baseSalary" [disabled]="modalMode === 'view'">
            </div>
            <div class="form-group">
              <label>L∆∞∆°ng ƒë√≥ng BH</label>
              <input type="number" [(ngModel)]="editingEmployee.insuranceSalary" [disabled]="modalMode === 'view'">
            </div>
            <div class="form-group">
              <label>H·ªá s·ªë l∆∞∆°ng</label>
              <input type="number" [(ngModel)]="editingEmployee.salaryCoefficient" [disabled]="modalMode === 'view'" step="0.01">
            </div>
          </div>

          <h4>Ng∆∞·ªùi ph·ª• thu·ªôc (gi·∫£m tr·ª´ gia c·∫£nh) - {{ getDependentCount() }} ng∆∞·ªùi</h4>
          <div class="dependent-list">
            <div class="dependent-item" *ngFor="let dep of editingEmployee.dependents; let i = index">
              <div class="form-row">
                <div class="form-group">
                  <label>H·ªç t√™n</label>
                  <input type="text" [(ngModel)]="dep.fullName" [disabled]="modalMode === 'view'">
                </div>
                <div class="form-group">
                  <label>Quan h·ªá</label>
                  <input type="text" [(ngModel)]="dep.relationship" [disabled]="modalMode === 'view'">
                </div>
                <div class="form-group">
                  <label>Ng√†y sinh</label>
                  <input type="date" [ngModel]="dep.dateOfBirth | date:'yyyy-MM-dd'"
                         (ngModelChange)="onDependentDateChange(i, 'dateOfBirth', $event)" [disabled]="modalMode === 'view'">
                </div>
                <div class="form-group">
                  <label>Gi·∫£m tr·ª´ t·ª´</label>
                  <input type="date" [ngModel]="dep.deductionFrom | date:'yyyy-MM-dd'"
                         (ngModelChange)="onDependentDateChange(i, 'deductionFrom', $event)" [disabled]="modalMode === 'view'">
                </div>
                <div class="form-group checkbox-group">
                  <label><input type="checkbox" [(ngModel)]="dep.isActive" [disabled]="modalMode === 'view'"> ƒêang gi·∫£m tr·ª´</label>
                </div>
                <button class="btn-icon btn-delete" *ngIf="modalMode !== 'view'" (click)="removeDependent(i)">üóëÔ∏è</button>
              </div>
            </div>
          </div>
          <button class="btn btn-secondary btn-sm" *ngIf="modalMode !== 'view'" (click)="addDependent()">
            ‚ûï Th√™m ng∆∞·ªùi ph·ª• thu·ªôc
          </button>
        </div>

        <!-- Tab: B·∫£o hi·ªÉm -->
        <div class="tab-content" *ngIf="activeTab === 'insurance'">
          <div class="form-row">
            <div class="form-group">
              <label>S·ªë s·ªï BHXH</label>
              <input type="text" [(ngModel)]="editingEmployee.insurance!.socialInsuranceNo" [disabled]="modalMode === 'view'">
            </div>
            <div class="form-group">
              <label>S·ªë th·∫ª BHYT</label>
              <input type="text" [(ngModel)]="editingEmployee.insurance!.healthInsuranceNo" [disabled]="modalMode === 'view'">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>N∆°i KCB ban ƒë·∫ßu</label>
              <input type="text" [(ngModel)]="editingEmployee.insurance!.healthInsurancePlace" [disabled]="modalMode === 'view'">
            </div>
            <div class="form-group">
              <label>L∆∞∆°ng ƒë√≥ng BH</label>
              <input type="number" [(ngModel)]="editingEmployee.insurance!.insuranceSalary" [disabled]="modalMode === 'view'">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Ng√†y tham gia BHXH</label>
              <input type="date" [ngModel]="editingEmployee.insurance!.socialInsuranceDate | date:'yyyy-MM-dd'"
                     (ngModelChange)="editingEmployee.insurance!.socialInsuranceDate = parseDate($event)" [disabled]="modalMode === 'view'">
            </div>
            <div class="form-group">
              <label>Ng√†y tham gia BHYT</label>
              <input type="date" [ngModel]="editingEmployee.insurance!.healthInsuranceDate | date:'yyyy-MM-dd'"
                     (ngModelChange)="editingEmployee.insurance!.healthInsuranceDate = parseDate($event)" [disabled]="modalMode === 'view'">
            </div>
            <div class="form-group">
              <label>Ng√†y tham gia BHTN</label>
              <input type="date" [ngModel]="editingEmployee.insurance!.unemploymentInsuranceDate | date:'yyyy-MM-dd'"
                     (ngModelChange)="editingEmployee.insurance!.unemploymentInsuranceDate = parseDate($event)" [disabled]="modalMode === 'view'">
            </div>
          </div>
        </div>

        <!-- Tab: Ng√¢n h√†ng -->
        <div class="tab-content" *ngIf="activeTab === 'bank'">
          <div class="form-row">
            <div class="form-group">
              <label>Ng√¢n h√†ng</label>
              <input type="text" [(ngModel)]="editingEmployee.bankAccount!.bankName" [disabled]="modalMode === 'view'"
                     placeholder="Vietcombank">
            </div>
            <div class="form-group">
              <label>Chi nh√°nh</label>
              <input type="text" [(ngModel)]="editingEmployee.bankAccount!.branch" [disabled]="modalMode === 'view'">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>S·ªë t√†i kho·∫£n</label>
              <input type="text" [(ngModel)]="editingEmployee.bankAccount!.accountNo" [disabled]="modalMode === 'view'">
            </div>
            <div class="form-group">
              <label>T√™n ch·ªß TK</label>
              <input type="text" [(ngModel)]="editingEmployee.bankAccount!.accountName" [disabled]="modalMode === 'view'"
                     placeholder="NGUYEN VAN A">
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer" *ngIf="modalMode !== 'view'">
        <button class="btn btn-secondary" (click)="closeModal()">H·ªßy</button>
        <button class="btn btn-primary" (click)="saveEmployee()">
          {{ modalMode === 'create' ? 'Th√™m m·ªõi' : 'C·∫≠p nh·∫≠t' }}
        </button>
      </div>
      <div class="modal-footer" *ngIf="modalMode === 'view'">
        <button class="btn btn-secondary" (click)="closeModal()">ƒê√≥ng</button>
        <button class="btn btn-primary" (click)="modalMode = 'edit'">Ch·ªânh s·ª≠a</button>
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div class="loading-overlay" *ngIf="isLoading">
    <div class="spinner"></div>
  </div>
</div>

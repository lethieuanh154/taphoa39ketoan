<div class="stock-card-page">
  <!-- HEADER -->
  <div class="page-header">
    <div>
      <h1 class="page-title">Th·∫ª Kho</h1>
      <p class="page-subtitle">Theo d√µi bi·∫øn ƒë·ªông nh·∫≠p xu·∫•t t·ªìn theo t·ª´ng s·∫£n ph·∫©m</p>
    </div>
    <div class="header-actions">
      <button class="btn btn-secondary" (click)="print()" [disabled]="!stockCard">
        <span class="icon">üñ®</span> In
      </button>
      <button class="btn btn-primary" (click)="exportToExcel()" [disabled]="!stockCard">
        <span class="icon">üì•</span> Xu·∫•t Excel
      </button>
    </div>
  </div>

  <!-- STATS CARDS -->
  <div class="stats-cards">
    <div class="stat-card card-total">
      <span class="stat-icon">üì¶</span>
      <div class="stat-content">
        <span class="stat-label">T·ªïng s·∫£n ph·∫©m</span>
        <span class="stat-value">{{ totalProducts }}</span>
      </div>
    </div>
    <div class="stat-card card-value">
      <span class="stat-icon">üí∞</span>
      <div class="stat-content">
        <span class="stat-label">T·ªïng gi√° tr·ªã t·ªìn</span>
        <span class="stat-value">{{ formatCurrency(totalStockValue) }}</span>
      </div>
    </div>
    <div class="stat-card card-warning">
      <span class="stat-icon">‚ö†Ô∏è</span>
      <div class="stat-content">
        <span class="stat-label">T·ªìn th·∫•p</span>
        <span class="stat-value">{{ lowStockCount }}</span>
      </div>
    </div>
  </div>

  <!-- FILTER SECTION -->
  <div class="filter-section">
    <div class="filter-row">
      <div class="filter-group filter-product">
        <label>S·∫£n ph·∫©m <span class="required">*</span></label>
        <select [(ngModel)]="selectedProductId" (change)="onProductChange()">
          <option value="">-- Ch·ªçn s·∫£n ph·∫©m --</option>
          <option *ngFor="let p of products" [value]="p.id">{{ p.code }} - {{ p.name }}</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Kho</label>
        <select [(ngModel)]="selectedWarehouseCode" (change)="onWarehouseChange()">
          <option value="">T·∫•t c·∫£ kho</option>
          <option *ngFor="let wh of warehouses" [value]="wh.code">{{ wh.name }}</option>
        </select>
      </div>
      <div class="filter-group">
        <label>T·ª´ ng√†y</label>
        <input type="date" [ngModel]="fromDate | date:'yyyy-MM-dd'"
               (ngModelChange)="onFromDateChange($event)">
      </div>
      <div class="filter-group">
        <label>ƒê·∫øn ng√†y</label>
        <input type="date" [ngModel]="toDate | date:'yyyy-MM-dd'"
               (ngModelChange)="onToDateChange($event)">
      </div>
    </div>
    <div class="filter-row">
      <div class="date-shortcuts">
        <button class="btn-chip" (click)="setDateRange('thisMonth')">Th√°ng n√†y</button>
        <button class="btn-chip" (click)="setDateRange('lastMonth')">Th√°ng tr∆∞·ªõc</button>
        <button class="btn-chip" (click)="setDateRange('thisQuarter')">Qu√Ω n√†y</button>
        <button class="btn-chip" (click)="setDateRange('thisYear')">NƒÉm nay</button>
      </div>
    </div>
  </div>

  <!-- PRODUCT INFO -->
  <div class="product-info-card" *ngIf="getSelectedProduct() as product">
    <div class="product-header">
      <div class="product-main">
        <span class="product-code">{{ product.code }}</span>
        <span class="product-name">{{ product.name }}</span>
      </div>
      <div class="product-meta">
        <span class="meta-item"><strong>ƒêVT:</strong> {{ product.unit }}</span>
        <span class="meta-item"><strong>Gi√° v·ªën:</strong> {{ formatCurrency(product.costPrice) }} ‚Ç´</span>
        <span class="meta-item"><strong>T·ªìn hi·ªán t·∫°i:</strong> {{ formatCurrency(product.currentStock) }}</span>
      </div>
    </div>
  </div>

  <!-- STOCK CARD REPORT -->
  <div class="report-container" *ngIf="stockCard">
    <!-- Summary -->
    <div class="summary-section">
      <div class="summary-grid">
        <div class="summary-box opening">
          <h4>T·ªìn ƒë·∫ßu k·ª≥</h4>
          <div class="summary-row">
            <span>S·ªë l∆∞·ª£ng:</span>
            <span>{{ formatCurrency(stockCard.openingQty) }}</span>
          </div>
          <div class="summary-row">
            <span>Gi√° tr·ªã:</span>
            <span>{{ formatCurrency(stockCard.openingAmount) }} ‚Ç´</span>
          </div>
        </div>

        <div class="summary-box receipt">
          <h4>Nh·∫≠p trong k·ª≥</h4>
          <div class="summary-row">
            <span>S·ªë l∆∞·ª£ng:</span>
            <span class="text-blue">+{{ formatCurrency(stockCard.receiptQty) }}</span>
          </div>
          <div class="summary-row">
            <span>Gi√° tr·ªã:</span>
            <span class="text-blue">{{ formatCurrency(stockCard.receiptAmount) }} ‚Ç´</span>
          </div>
        </div>

        <div class="summary-box issue">
          <h4>Xu·∫•t trong k·ª≥</h4>
          <div class="summary-row">
            <span>S·ªë l∆∞·ª£ng:</span>
            <span class="text-red">-{{ formatCurrency(stockCard.issueQty) }}</span>
          </div>
          <div class="summary-row">
            <span>Gi√° tr·ªã:</span>
            <span class="text-red">{{ formatCurrency(stockCard.issueAmount) }} ‚Ç´</span>
          </div>
        </div>

        <div class="summary-box closing">
          <h4>T·ªìn cu·ªëi k·ª≥</h4>
          <div class="summary-row">
            <span>S·ªë l∆∞·ª£ng:</span>
            <span class="text-green">{{ formatCurrency(stockCard.closingQty) }}</span>
          </div>
          <div class="summary-row">
            <span>Gi√° tr·ªã:</span>
            <span class="text-green">{{ formatCurrency(stockCard.closingAmount) }} ‚Ç´</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Movements Table -->
    <div class="table-section">
      <h3 class="section-title">Chi ti·∫øt bi·∫øn ƒë·ªông</h3>
      <div class="table-container">
        <table class="data-table">
          <thead>
            <tr>
              <th class="col-date">Ng√†y</th>
              <th class="col-voucher">S·ªë ch·ª©ng t·ª´</th>
              <th class="col-type">Lo·∫°i</th>
              <th class="col-desc">Di·ªÖn gi·∫£i</th>
              <th class="col-qty text-right">Nh·∫≠p SL</th>
              <th class="col-amount text-right">Nh·∫≠p TT</th>
              <th class="col-qty text-right">Xu·∫•t SL</th>
              <th class="col-amount text-right">Xu·∫•t TT</th>
              <th class="col-qty text-right">T·ªìn SL</th>
              <th class="col-amount text-right">T·ªìn TT</th>
            </tr>
          </thead>
          <tbody>
            <!-- Opening row -->
            <tr class="opening-row">
              <td>{{ formatDate(fromDate) }}</td>
              <td></td>
              <td></td>
              <td><strong>T·ªìn ƒë·∫ßu k·ª≥</strong></td>
              <td class="text-right"></td>
              <td class="text-right"></td>
              <td class="text-right"></td>
              <td class="text-right"></td>
              <td class="text-right">{{ formatCurrency(stockCard.openingQty) }}</td>
              <td class="text-right">{{ formatCurrency(stockCard.openingAmount) }}</td>
            </tr>

            <!-- Movement rows -->
            <tr *ngFor="let movement of stockCard.movements">
              <td>{{ formatDate(movement.date) }}</td>
              <td><span class="voucher-no">{{ movement.voucherNo }}</span></td>
              <td>
                <span class="type-badge" [ngClass]="getMovementTypeClass(movement.voucherType)">
                  {{ getMovementTypeLabel(movement.voucherType) }}
                </span>
              </td>
              <td>{{ movement.description }}</td>
              <td class="text-right text-blue" *ngIf="movement.receiptQty">{{ formatCurrency(movement.receiptQty) }}</td>
              <td class="text-right" *ngIf="!movement.receiptQty"></td>
              <td class="text-right text-blue" *ngIf="movement.receiptAmount">{{ formatCurrency(movement.receiptAmount) }}</td>
              <td class="text-right" *ngIf="!movement.receiptAmount"></td>
              <td class="text-right text-red" *ngIf="movement.issueQty">{{ formatCurrency(movement.issueQty) }}</td>
              <td class="text-right" *ngIf="!movement.issueQty"></td>
              <td class="text-right text-red" *ngIf="movement.issueAmount">{{ formatCurrency(movement.issueAmount) }}</td>
              <td class="text-right" *ngIf="!movement.issueAmount"></td>
              <td class="text-right">{{ formatCurrency(movement.balanceQty) }}</td>
              <td class="text-right">{{ formatCurrency(movement.balanceAmount) }}</td>
            </tr>

            <!-- Closing row -->
            <tr class="closing-row">
              <td>{{ formatDate(toDate) }}</td>
              <td></td>
              <td></td>
              <td><strong>T·ªìn cu·ªëi k·ª≥</strong></td>
              <td class="text-right text-blue"><strong>{{ formatCurrency(stockCard.receiptQty) }}</strong></td>
              <td class="text-right text-blue"><strong>{{ formatCurrency(stockCard.receiptAmount) }}</strong></td>
              <td class="text-right text-red"><strong>{{ formatCurrency(stockCard.issueQty) }}</strong></td>
              <td class="text-right text-red"><strong>{{ formatCurrency(stockCard.issueAmount) }}</strong></td>
              <td class="text-right text-green"><strong>{{ formatCurrency(stockCard.closingQty) }}</strong></td>
              <td class="text-right text-green"><strong>{{ formatCurrency(stockCard.closingAmount) }}</strong></td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Empty movements -->
      <div class="empty-movements" *ngIf="stockCard.movements.length === 0">
        <p>Kh√¥ng c√≥ bi·∫øn ƒë·ªông trong k·ª≥ n√†y</p>
      </div>
    </div>
  </div>

  <!-- No product selected -->
  <div class="empty-state" *ngIf="!selectedProductId && !isLoading">
    <div class="empty-icon">üìã</div>
    <p>Ch·ªçn s·∫£n ph·∫©m ƒë·ªÉ xem th·∫ª kho</p>
    <p class="empty-text">Th·∫ª kho theo d√µi chi ti·∫øt nh·∫≠p - xu·∫•t - t·ªìn c·ªßa t·ª´ng s·∫£n ph·∫©m</p>
  </div>

  <!-- Loading -->
  <div class="loading-overlay" *ngIf="isLoading">
    <div class="spinner"></div>
  </div>
</div>

<div class="payable-ledger-page">
  <!-- HEADER -->
  <div class="page-header">
    <div>
      <h1 class="page-title">S·ªï Chi Ti·∫øt TK 331</h1>
      <p class="page-subtitle">C√¥ng n·ª£ ph·∫£i tr·∫£ nh√† cung c·∫•p</p>
    </div>
    <div class="header-actions">
      <button class="btn btn-secondary" (click)="loadData()"><span class="icon">üîÑ</span> T·∫£i l·∫°i</button>
      <button class="btn btn-secondary" (click)="print()"><span class="icon">üñ®</span> In</button>
      <button class="btn btn-primary" (click)="exportToExcel()"><span class="icon">üì•</span> Xu·∫•t Excel</button>
    </div>
  </div>

  <!-- ERROR MESSAGE -->
  @if (errorMessage()) {
    <div class="error-banner">
      <span>‚ö†Ô∏è {{ errorMessage() }}</span>
      <button class="btn-close" (click)="errorMessage.set(null)">√ó</button>
    </div>
  }

  <!-- SUMMARY CARDS -->
  <div class="summary-cards">
    <div class="summary-card card-suppliers"><div class="card-icon">üè≠</div><div class="card-content"><span class="card-label">Nh√† cung c·∫•p</span><span class="card-value">{{ summary().totalSuppliers }}</span></div></div>
    <div class="summary-card card-opening"><div class="card-icon">üìã</div><div class="card-content"><span class="card-label">D∆∞ ƒë·∫ßu k·ª≥</span><span class="card-value">{{ formatCurrency(summary().totalOpeningBalance) }}</span></div></div>
    <div class="summary-card card-debit"><div class="card-icon">üìâ</div><div class="card-content"><span class="card-label">PS N·ª£ (Tr·∫£)</span><span class="card-value text-green">{{ formatCurrency(summary().totalDebit) }}</span></div></div>
    <div class="summary-card card-credit"><div class="card-icon">üìà</div><div class="card-content"><span class="card-label">PS C√≥ (Mua)</span><span class="card-value text-purple">{{ formatCurrency(summary().totalCredit) }}</span></div></div>
    <div class="summary-card card-closing"><div class="card-icon">üí∞</div><div class="card-content"><span class="card-label">D∆∞ cu·ªëi k·ª≥</span><span class="card-value text-red">{{ formatCurrency(summary().totalClosingBalance) }}</span></div></div>
  </div>

  <!-- FILTER SECTION -->
  <div class="filter-section">
    <div class="filter-row">
      <div class="filter-group filter-supplier">
        <label>Nh√† cung c·∫•p</label>
        <select [ngModel]="selectedSupplierId()" (ngModelChange)="selectedSupplierId.set($event); onSupplierChange()">
          <option value="">-- T·∫•t c·∫£ NCC --</option>
          @for (s of suppliers(); track s.id) {
            <option [value]="s.id">{{ s.code }} - {{ s.name }}</option>
          }
        </select>
      </div>
      <div class="filter-group">
        <label>T·ª´ ng√†y</label>
        <input type="date" [value]="formatDateForInput(fromDate())" (change)="onFromDateChange($any($event.target).value)">
      </div>
      <div class="filter-group">
        <label>ƒê·∫øn ng√†y</label>
        <input type="date" [value]="formatDateForInput(toDate())" (change)="onToDateChange($any($event.target).value)">
      </div>
      <div class="filter-group">
        <div class="date-shortcuts">
          <button class="btn-chip" (click)="setDateRange('thisMonth')">Th√°ng n√†y</button>
          <button class="btn-chip" (click)="setDateRange('lastMonth')">Th√°ng tr∆∞·ªõc</button>
          <button class="btn-chip" (click)="setDateRange('thisQuarter')">Qu√Ω n√†y</button>
          <button class="btn-chip" (click)="setDateRange('thisYear')">NƒÉm nay</button>
        </div>
      </div>
    </div>
  </div>

  <!-- VIEW TABS -->
  <div class="view-tabs">
    <button class="tab-btn" [class.active]="viewMode() === 'summary'" (click)="showSummary()">T·ªïng h·ª£p</button>
    <button class="tab-btn" [class.active]="viewMode() === 'detail'" [disabled]="!selectedSupplierId()">Chi ti·∫øt</button>
  </div>

  <!-- SUMMARY VIEW -->
  @if (viewMode() === 'summary') {
    <div class="table-container">
      <div class="report-title">
        <h2>S·ªî CHI TI·∫æT T√ÄI KHO·∫¢N 331 - PH·∫¢I TR·∫¢ NH√Ä CUNG C·∫§P</h2>
        <p>K·ª≥: {{ formatDate(fromDate()) }} - {{ formatDate(toDate()) }}</p>
      </div>
      <table class="data-table">
        <thead>
          <tr>
            <th class="col-no">STT</th>
            <th class="col-code">M√£ NCC</th>
            <th class="col-name">T√™n nh√† cung c·∫•p</th>
            <th class="col-amount text-right">D∆∞ ƒë·∫ßu k·ª≥</th>
            <th class="col-amount text-right">PS N·ª£</th>
            <th class="col-amount text-right">PS C√≥</th>
            <th class="col-amount text-right">D∆∞ cu·ªëi k·ª≥</th>
            <th class="col-action"></th>
          </tr>
        </thead>
        <tbody>
          @for (item of supplierPayables(); track item.supplierId; let i = $index) {
            <tr>
              <td>{{ i + 1 }}</td>
              <td><span class="supplier-code">{{ item.supplierCode }}</span></td>
              <td>{{ item.supplierName }}</td>
              <td class="text-right">{{ formatCurrency(item.openingBalance) }}</td>
              <td class="text-right text-green">{{ formatCurrency(item.totalDebit) }}</td>
              <td class="text-right text-purple">{{ formatCurrency(item.totalCredit) }}</td>
              <td class="text-right" [ngClass]="getBalanceClass(item.closingBalance)"><strong>{{ formatCurrency(item.closingBalance) }}</strong></td>
              <td><button class="btn-icon btn-view" title="Xem chi ti·∫øt" (click)="showDetail(item.supplierId)">üëÅ</button></td>
            </tr>
          }
        </tbody>
        <tfoot>
          <tr class="total-row">
            <td colspan="3"><strong>T·ªîNG C·ªòNG</strong></td>
            <td class="text-right"><strong>{{ formatCurrency(summary().totalOpeningBalance) }}</strong></td>
            <td class="text-right text-green"><strong>{{ formatCurrency(summary().totalDebit) }}</strong></td>
            <td class="text-right text-purple"><strong>{{ formatCurrency(summary().totalCredit) }}</strong></td>
            <td class="text-right text-red"><strong>{{ formatCurrency(summary().totalClosingBalance) }}</strong></td>
            <td></td>
          </tr>
        </tfoot>
      </table>
      @if (supplierPayables().length === 0 && !isLoading()) {
        <div class="empty-state">
          <div class="empty-icon">üìã</div>
          <p>Kh√¥ng c√≥ d·ªØ li·ªáu c√¥ng n·ª£</p>
          <p class="hint">H√£y ƒë·ªìng b·ªô h√≥a ƒë∆°n mua v√†o ho·∫∑c t·∫°o phi·∫øu chi ƒë·ªÉ xem d·ªØ li·ªáu</p>
        </div>
      }
    </div>
  }

  <!-- DETAIL VIEW -->
  @if (viewMode() === 'detail' && selectedSupplierData()) {
    <div class="table-container">
      <div class="report-title">
        <h2>S·ªî CHI TI·∫æT TK 331</h2>
        <p class="supplier-info">{{ selectedSupplierData()!.supplierCode }} - {{ selectedSupplierData()!.supplierName }}</p>
        <p>K·ª≥: {{ formatDate(fromDate()) }} - {{ formatDate(toDate()) }}</p>
      </div>
      <table class="data-table">
        <thead>
          <tr>
            <th class="col-date">Ng√†y</th>
            <th class="col-voucher">S·ªë ch·ª©ng t·ª´</th>
            <th class="col-type">Lo·∫°i</th>
            <th class="col-desc">Di·ªÖn gi·∫£i</th>
            <th class="col-amount text-right">PS N·ª£</th>
            <th class="col-amount text-right">PS C√≥</th>
            <th class="col-amount text-right">S·ªë d∆∞</th>
          </tr>
        </thead>
        <tbody>
          <tr class="opening-row">
            <td>{{ formatDate(fromDate()) }}</td>
            <td></td>
            <td></td>
            <td><strong>D∆∞ ƒë·∫ßu k·ª≥</strong></td>
            <td class="text-right"></td>
            <td class="text-right"></td>
            <td class="text-right"><strong>{{ formatCurrency(selectedSupplierData()!.openingBalance) }}</strong></td>
          </tr>
          @for (line of selectedSupplierData()!.lines; track line.voucherNo) {
            <tr>
              <td>{{ formatDate(line.date) }}</td>
              <td><span class="voucher-no">{{ line.voucherNo }}</span></td>
              <td><span class="type-badge" [ngClass]="'type-' + line.voucherType.toLowerCase()">{{ getVoucherTypeLabel(line.voucherType) }}</span></td>
              <td>{{ line.description }}</td>
              @if (line.debitAmount) {
                <td class="text-right text-green">{{ formatCurrency(line.debitAmount) }}</td>
              } @else {
                <td class="text-right"></td>
              }
              @if (line.creditAmount) {
                <td class="text-right text-purple">{{ formatCurrency(line.creditAmount) }}</td>
              } @else {
                <td class="text-right"></td>
              }
              <td class="text-right">{{ formatCurrency(line.balance) }}</td>
            </tr>
          }
          <tr class="closing-row">
            <td>{{ formatDate(toDate()) }}</td>
            <td></td>
            <td></td>
            <td><strong>C·ªông ph√°t sinh</strong></td>
            <td class="text-right text-green"><strong>{{ formatCurrency(selectedSupplierData()!.totalDebit) }}</strong></td>
            <td class="text-right text-purple"><strong>{{ formatCurrency(selectedSupplierData()!.totalCredit) }}</strong></td>
            <td class="text-right"></td>
          </tr>
          <tr class="closing-row">
            <td></td>
            <td></td>
            <td></td>
            <td><strong>D∆∞ cu·ªëi k·ª≥</strong></td>
            <td class="text-right"></td>
            <td class="text-right"></td>
            <td class="text-right text-red"><strong>{{ formatCurrency(selectedSupplierData()!.closingBalance) }}</strong></td>
          </tr>
        </tbody>
      </table>
      <button class="btn btn-secondary" style="margin-top: 16px;" (click)="showSummary()">‚Üê Quay l·∫°i t·ªïng h·ª£p</button>
    </div>
  }

  @if (isLoading()) {
    <div class="loading-overlay"><div class="spinner"></div></div>
  }
</div>

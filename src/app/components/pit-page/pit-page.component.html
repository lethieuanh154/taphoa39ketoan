<div class="pit-page">
  <!-- HEADER -->
  <div class="page-header">
    <div class="header-left">
      <h1>üíº Thu·∫ø Thu Nh·∫≠p C√° Nh√¢n</h1>
      <p class="subtitle">TK 3335 - Thu·∫ø TNCN ph·∫£i n·ªôp</p>
    </div>
    <div class="header-actions">
      <select [(ngModel)]="filterYear" (change)="onYearChange()" class="year-select">
        <option *ngFor="let y of years" [value]="y">NƒÉm {{ y }}</option>
      </select>
      <button class="btn btn-primary" (click)="openCreateModal()">
        + T·∫°o t·ªù khai
      </button>
    </div>
  </div>

  <!-- TAX BRACKETS INFO -->
  <div class="brackets-info">
    <div class="brackets-title">Bi·ªÉu thu·∫ø l≈©y ti·∫øn t·ª´ng ph·∫ßn</div>
    <div class="brackets-table">
      <table>
        <thead>
          <tr>
            <th>B·∫≠c</th>
            <th>Thu nh·∫≠p t√≠nh thu·∫ø/th√°ng</th>
            <th>Thu·∫ø su·∫•t</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let bracket of brackets; let i = index">
            <td>{{ i + 1 }}</td>
            <td>
              <span *ngIf="isLastBracket(bracket)">Tr√™n {{ formatCurrency(bracket.from) }}</span>
              <span *ngIf="!isLastBracket(bracket)">{{ formatCurrency(bracket.from) }} - {{ formatCurrency(bracket.to) }}</span>
            </td>
            <td>{{ formatPercent(bracket.rate) }}</td>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="deduction-info">
      <span>Gi·∫£m tr·ª´ b·∫£n th√¢n: <strong>{{ formatCurrency(personalDeduction) }}/th√°ng</strong></span>
      <span>Gi·∫£m tr·ª´ NPT: <strong>{{ formatCurrency(dependentDeduction) }}/ng∆∞·ªùi/th√°ng</strong></span>
    </div>
  </div>

  <!-- SUMMARY CARDS -->
  <div class="summary-cards">
    <div class="card total-declarations">
      <div class="card-icon">üìã</div>
      <div class="card-content">
        <span class="card-value">{{ yearStats.declarationCount }}</span>
        <span class="card-label">T·ªù khai</span>
      </div>
    </div>
    <div class="card total-pit">
      <div class="card-icon">üí∞</div>
      <div class="card-content">
        <span class="card-value">{{ formatCurrency(yearStats.totalPIT) }}</span>
        <span class="card-label">T·ªïng thu·∫ø TNCN</span>
      </div>
    </div>
    <div class="card paid-pit">
      <div class="card-icon">‚úÖ</div>
      <div class="card-content">
        <span class="card-value">{{ formatCurrency(yearStats.paidPIT) }}</span>
        <span class="card-label">ƒê√£ n·ªôp</span>
      </div>
    </div>
    <div class="card unpaid-pit">
      <div class="card-icon">‚è≥</div>
      <div class="card-content">
        <span class="card-value">{{ formatCurrency(yearStats.unpaidPIT) }}</span>
        <span class="card-label">Ch∆∞a n·ªôp</span>
      </div>
    </div>
  </div>

  <!-- DECLARATION LIST -->
  <div class="declaration-list">
    <div class="list-header">
      <h2>T·ªù khai thu·∫ø TNCN nƒÉm {{ filterYear }}</h2>
    </div>

    <div class="table-container">
      <table class="data-table">
        <thead>
          <tr>
            <th>K·ª≥</th>
            <th>S·ªë t·ªù khai</th>
            <th>S·ªë NV</th>
            <th>NV n·ªôp thu·∫ø</th>
            <th>T·ªïng TN ch·ªãu thu·∫ø</th>
            <th>TN t√≠nh thu·∫ø</th>
            <th>Thu·∫ø TNCN</th>
            <th>H·∫°n n·ªôp</th>
            <th>Tr·∫°ng th√°i</th>
            <th>Thao t√°c</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let dec of declarations"
              [class.overdue]="isOverdue(dec)"
              (click)="viewDeclaration(dec)">
            <td><strong>{{ dec.period }}</strong></td>
            <td>{{ dec.declarationNo }}</td>
            <td class="center">{{ dec.summary.employeeCount }}</td>
            <td class="center">{{ dec.summary.taxableEmployeeCount }}</td>
            <td class="amount">{{ formatCurrency(dec.summary.totalTaxableIncome) }}</td>
            <td class="amount">{{ formatCurrency(dec.summary.totalTaxableAmount) }}</td>
            <td class="amount highlight">{{ formatCurrency(dec.summary.totalPITAmount) }}</td>
            <td>
              {{ formatDate(dec.submissionDeadline) }}
              <span class="overdue-badge" *ngIf="isOverdue(dec)">Qu√° h·∫°n</span>
            </td>
            <td>
              <span class="status-badge" [ngClass]="getStatusClass(dec.status)">
                {{ getStatusLabel(dec.status) }}
              </span>
            </td>
            <td (click)="$event.stopPropagation()">
              <button class="btn-icon" title="Xem" (click)="viewDeclaration(dec)">üëÅÔ∏è</button>
              <button class="btn-icon" title="X√≥a" *ngIf="dec.status === 'DRAFT'" (click)="deleteDeclaration(dec.id)">üóëÔ∏è</button>
            </td>
          </tr>
          <tr *ngIf="declarations.length === 0">
            <td colspan="10" class="empty-row">Ch∆∞a c√≥ t·ªù khai thu·∫ø TNCN n√†o trong nƒÉm {{ filterYear }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- CREATE MODAL -->
  <div class="modal-overlay" *ngIf="showCreateModal" (click)="closeCreateModal()">
    <div class="modal create-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>T·∫°o t·ªù khai thu·∫ø TNCN</h2>
        <button class="btn-close" (click)="closeCreateModal()">√ó</button>
      </div>

      <div class="modal-body">
        <h3>Ch·ªçn b·∫£ng l∆∞∆°ng</h3>
        <div class="payroll-list">
          <div *ngFor="let payroll of payrolls"
               class="payroll-item"
               [class.selected]="selectedPayroll?.id === payroll.id"
               (click)="selectPayroll(payroll)">
            <div class="payroll-info">
              <span class="payroll-no">{{ payroll.payrollNo }}</span>
              <span class="payroll-period">Th√°ng {{ payroll.month }}/{{ payroll.year }}</span>
            </div>
            <div class="payroll-pit">
              <span class="label">Thu·∫ø TNCN:</span>
              <span class="value">{{ formatCurrency(payroll.summary.totalPIT) }}</span>
            </div>
          </div>
          <div *ngIf="payrolls.length === 0" class="no-data">
            Kh√¥ng c√≥ b·∫£ng l∆∞∆°ng ƒë√£ duy·ªát
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeCreateModal()">H·ªßy</button>
        <button class="btn btn-primary" (click)="createDeclaration()" [disabled]="!selectedPayroll">
          T·∫°o t·ªù khai
        </button>
      </div>
    </div>
  </div>

  <!-- DETAIL MODAL -->
  <div class="modal-overlay" *ngIf="showDetailModal" (click)="closeDetailModal()">
    <div class="modal detail-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div>
          <h2>{{ editingDeclaration?.declarationNo }} - K·ª≥ {{ editingDeclaration?.period }}</h2>
          <span class="status-badge" [ngClass]="getStatusClass(editingDeclaration?.status || 'DRAFT')">
            {{ getStatusLabel(editingDeclaration?.status || 'DRAFT') }}
          </span>
        </div>
        <div class="header-actions">
          <button class="btn btn-secondary" (click)="print()">üñ®Ô∏è In</button>
          <button class="btn-close" (click)="closeDetailModal()">√ó</button>
        </div>
      </div>

      <div class="modal-body" *ngIf="editingDeclaration">
        <!-- Summary -->
        <div class="summary-grid">
          <div class="summary-item">
            <span class="label">S·ªë nh√¢n vi√™n:</span>
            <span class="value">{{ editingDeclaration.summary.employeeCount }}</span>
          </div>
          <div class="summary-item">
            <span class="label">NV n·ªôp thu·∫ø:</span>
            <span class="value">{{ editingDeclaration.summary.taxableEmployeeCount }}</span>
          </div>
          <div class="summary-item">
            <span class="label">T·ªïng TN ch·ªãu thu·∫ø:</span>
            <span class="value">{{ formatCurrency(editingDeclaration.summary.totalTaxableIncome) }}</span>
          </div>
          <div class="summary-item">
            <span class="label">T·ªïng gi·∫£m tr·ª´:</span>
            <span class="value">{{ formatCurrency(editingDeclaration.summary.totalPersonalDeduction + editingDeclaration.summary.totalDependentDeduction) }}</span>
          </div>
          <div class="summary-item">
            <span class="label">TN t√≠nh thu·∫ø:</span>
            <span class="value">{{ formatCurrency(editingDeclaration.summary.totalTaxableAmount) }}</span>
          </div>
          <div class="summary-item main">
            <span class="label">Thu·∫ø TNCN:</span>
            <span class="value">{{ formatCurrency(editingDeclaration.summary.totalPITAmount) }}</span>
          </div>
        </div>

        <!-- Detail Table -->
        <div class="detail-table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>STT</th>
                <th>M√£ NV</th>
                <th>H·ªç v√† t√™n</th>
                <th>MST</th>
                <th>T·ªïng TN</th>
                <th>BH tr·ª´</th>
                <th>TN ch·ªãu thu·∫ø</th>
                <th>GT b·∫£n th√¢n</th>
                <th>S·ªë NPT</th>
                <th>GT NPT</th>
                <th>TN t√≠nh thu·∫ø</th>
                <th>Thu·∫ø TNCN</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let detail of editingDeclaration.details; let i = index"
                  [class.no-tax]="detail.pitAmount === 0">
                <td class="center">{{ i + 1 }}</td>
                <td>{{ detail.employeeCode }}</td>
                <td class="name">{{ detail.employeeName }}</td>
                <td>{{ detail.taxCode || '-' }}</td>
                <td class="amount">{{ formatCurrency(detail.grossSalary) }}</td>
                <td class="amount">{{ formatCurrency(detail.insuranceDeduction) }}</td>
                <td class="amount">{{ formatCurrency(detail.taxableIncome) }}</td>
                <td class="amount">{{ formatCurrency(detail.personalDeduction) }}</td>
                <td class="center">{{ detail.dependentCount }}</td>
                <td class="amount">{{ formatCurrency(detail.dependentDeduction) }}</td>
                <td class="amount">{{ formatCurrency(detail.taxableAmount) }}</td>
                <td class="amount highlight">{{ formatCurrency(detail.pitAmount) }}</td>
              </tr>
            </tbody>
            <tfoot>
              <tr class="total-row">
                <td colspan="4"><strong>T·ªîNG C·ªòNG</strong></td>
                <td class="amount"><strong>{{ formatCurrency(editingDeclaration.summary.totalGrossSalary) }}</strong></td>
                <td class="amount"><strong>{{ formatCurrency(editingDeclaration.summary.totalInsuranceDeduction) }}</strong></td>
                <td class="amount"><strong>{{ formatCurrency(editingDeclaration.summary.totalTaxableIncome) }}</strong></td>
                <td class="amount"><strong>{{ formatCurrency(editingDeclaration.summary.totalPersonalDeduction) }}</strong></td>
                <td></td>
                <td class="amount"><strong>{{ formatCurrency(editingDeclaration.summary.totalDependentDeduction) }}</strong></td>
                <td class="amount"><strong>{{ formatCurrency(editingDeclaration.summary.totalTaxableAmount) }}</strong></td>
                <td class="amount highlight"><strong>{{ formatCurrency(editingDeclaration.summary.totalPITAmount) }}</strong></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>

      <div class="modal-footer">
        <div class="footer-left">
          <span>H·∫°n n·ªôp: {{ formatDate(editingDeclaration?.submissionDeadline) }}</span>
          <span *ngIf="editingDeclaration?.submittedAt">| N·ªôp: {{ formatDate(editingDeclaration?.submittedAt) }}</span>
          <span *ngIf="editingDeclaration?.paidAt">| N·ªôp thu·∫ø: {{ formatDate(editingDeclaration?.paidAt) }}</span>
        </div>
        <div class="footer-right">
          <button class="btn btn-secondary" (click)="closeDetailModal()">ƒê√≥ng</button>

          <ng-container *ngIf="editingDeclaration?.status === 'DRAFT'">
            <button class="btn btn-primary" (click)="submitDeclaration(editingDeclaration!.id)">üì§ N·ªôp t·ªù khai</button>
          </ng-container>

          <ng-container *ngIf="editingDeclaration?.status === 'SUBMITTED'">
            <button class="btn btn-success" (click)="markAsPaid(editingDeclaration!.id)">üí∞ X√°c nh·∫≠n n·ªôp thu·∫ø</button>
          </ng-container>
        </div>
      </div>
    </div>
  </div>

  <!-- LOADING -->
  <div class="loading-overlay" *ngIf="isLoading">
    <div class="spinner"></div>
  </div>
</div>

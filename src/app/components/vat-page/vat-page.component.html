<div class="vat-page">
  <!-- HEADER -->
  <div class="page-header">
    <div>
      <h1 class="page-title">Thu·∫ø GTGT</h1>
      <p class="page-subtitle">T·ªù khai thu·∫ø GTGT theo m·∫´u 01/GTGT - Th√¥ng t∆∞ 80/2021/TT-BTC</p>
    </div>
    <button class="btn btn-primary" (click)="openCreateModal()">
      <span class="icon">+</span>
      T·∫°o t·ªù khai m·ªõi
    </button>
  </div>

  <!-- STATS CARDS -->
  <div class="stats-cards">
    <div class="stat-card card-total">
      <span class="stat-icon">üìã</span>
      <div class="stat-content">
        <span class="stat-label">T·ªïng t·ªù khai</span>
        <span class="stat-value">{{ summary.totalDeclarations }}</span>
      </div>
    </div>
    <div class="stat-card card-draft">
      <span class="stat-icon">üìù</span>
      <div class="stat-content">
        <span class="stat-label">Nh√°p</span>
        <span class="stat-value">{{ summary.draftCount }}</span>
      </div>
    </div>
    <div class="stat-card card-submitted">
      <span class="stat-icon">‚úÖ</span>
      <div class="stat-content">
        <span class="stat-label">ƒê√£ n·ªôp</span>
        <span class="stat-value">{{ summary.submittedCount }}</span>
      </div>
    </div>
    <div class="stat-card card-output">
      <span class="stat-icon">üì§</span>
      <div class="stat-content">
        <span class="stat-label">Thu·∫ø ƒë·∫ßu ra</span>
        <span class="stat-value">{{ formatCurrency(summary.totalVatOutput) }}</span>
      </div>
    </div>
    <div class="stat-card card-input">
      <span class="stat-icon">üì•</span>
      <div class="stat-content">
        <span class="stat-label">Thu·∫ø ƒë·∫ßu v√†o</span>
        <span class="stat-value">{{ formatCurrency(summary.totalVatInput) }}</span>
      </div>
    </div>
  </div>

  <!-- FILTERS -->
  <div class="filter-section">
    <div class="filter-row">
      <div class="filter-group">
        <label>NƒÉm</label>
        <select [(ngModel)]="filterYear" (change)="onYearChange()">
          <option *ngFor="let year of years" [value]="year">{{ year }}</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Tr·∫°ng th√°i</label>
        <select [(ngModel)]="filterStatus" (change)="onStatusFilterChange()">
          <option value="">T·∫•t c·∫£</option>
          <option value="DRAFT">Nh√°p</option>
          <option value="SUBMITTED">ƒê√£ n·ªôp</option>
          <option value="ADJUSTED">ƒêi·ªÅu ch·ªânh</option>
        </select>
      </div>
    </div>
  </div>

  <!-- DATA TABLE -->
  <div class="table-container">
    <table class="data-table">
      <thead>
        <tr>
          <th class="col-no">STT</th>
          <th class="col-period">K·ª≥ k√™ khai</th>
          <th class="col-no-declaration">S·ªë t·ªù khai</th>
          <th class="text-right">Doanh s·ªë b√°n ra</th>
          <th class="text-right">Thu·∫ø ƒë·∫ßu ra</th>
          <th class="text-right">Thu·∫ø ƒë·∫ßu v√†o</th>
          <th class="text-right">Ph·∫£i n·ªôp/Kh·∫•u tr·ª´</th>
          <th class="col-status">Tr·∫°ng th√°i</th>
          <th class="col-actions">Thao t√°c</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let declaration of filteredDeclarations; let i = index">
          <td>{{ i + 1 }}</td>
          <td>
            <span class="period-name">{{ formatPeriod(declaration) }}</span>
            <span class="amendment-badge" *ngIf="declaration.isAmendment">BS{{ declaration.amendmentNo }}</span>
          </td>
          <td>{{ declaration.declarationNo }}</td>
          <td class="text-right">{{ formatCurrency(declaration.totalSales) }}</td>
          <td class="text-right">{{ formatCurrency(declaration.totalVatOutput) }}</td>
          <td class="text-right">{{ formatCurrency(declaration.totalVatInput) }}</td>
          <td class="text-right" [ngClass]="getVatResultClass(declaration.vatPayableOrCredit)">
            {{ formatCurrency(declaration.vatPayableOrCredit) }}
            <span class="result-label" *ngIf="declaration.vatPayableOrCredit > 0">(N·ªôp)</span>
            <span class="result-label" *ngIf="declaration.vatPayableOrCredit < 0">(Kh·∫•u tr·ª´)</span>
          </td>
          <td>
            <span class="status-badge" [ngClass]="getStatusClass(declaration.status)">
              {{ statusLabels[declaration.status] }}
            </span>
          </td>
          <td>
            <div class="action-buttons">
              <button class="btn-icon btn-view" title="Xem chi ti·∫øt" (click)="viewDetail(declaration)">üëÅ</button>
              <button class="btn-icon btn-edit" title="S·ª≠a" (click)="openEditModal(declaration)"
                      *ngIf="declaration.status === 'DRAFT'">‚úèÔ∏è</button>
              <button class="btn-icon btn-delete" title="X√≥a" (click)="deleteDeclaration(declaration)"
                      *ngIf="declaration.status === 'DRAFT'">üóë</button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Empty State -->
    <div class="empty-state" *ngIf="filteredDeclarations.length === 0 && !isLoading">
      <div class="empty-icon">üìã</div>
      <p>Ch∆∞a c√≥ t·ªù khai thu·∫ø GTGT n√†o</p>
      <p class="empty-text">Nh·∫•n "T·∫°o t·ªù khai m·ªõi" ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
    </div>
  </div>

  <!-- CREATE MODAL -->
  <div class="modal-overlay" *ngIf="showCreateModal" (click)="closeCreateModal()">
    <div class="modal modal-small" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>T·∫°o T·ªù Khai GTGT M·ªõi</h2>
        <button class="btn-close" (click)="closeCreateModal()">√ó</button>
      </div>

      <div class="modal-body">
        <div class="form-group">
          <label>K·ª≥ k√™ khai <span class="required">*</span></label>
          <div class="period-select">
            <select [(ngModel)]="newPeriodMonth">
              <option *ngFor="let m of months" [value]="m">Th√°ng {{ m }}</option>
            </select>
            <select [(ngModel)]="newPeriodYear">
              <option *ngFor="let y of years" [value]="y">{{ y }}</option>
            </select>
          </div>
        </div>

        <div class="info-note">
          <p>T·ªù khai s·∫Ω ƒë∆∞·ª£c t·∫°o v·ªõi tr·∫°ng th√°i <strong>Nh√°p</strong>.</p>
          <p>B·∫°n c√≥ th·ªÉ nh·∫≠p s·ªë li·ªáu v√† n·ªôp sau.</p>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeCreateModal()">H·ªßy</button>
        <button class="btn btn-primary" (click)="createDeclaration()">T·∫°o t·ªù khai</button>
      </div>
    </div>
  </div>

  <!-- EDIT MODAL -->
  <div class="modal-overlay" *ngIf="showEditModal" (click)="closeEditModal()">
    <div class="modal modal-large" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>S·ª≠a T·ªù Khai GTGT - {{ getEditingPeriodName() }}</h2>
        <button class="btn-close" (click)="closeEditModal()">√ó</button>
      </div>

      <div class="modal-body">
        <!-- Output Section -->
        <div class="form-section">
          <h3 class="section-title">I. H√ÄNG H√ìA D·ªäCH V·ª§ B√ÅN RA</h3>

          <div class="form-grid">
            <div class="form-group col-span-2">
              <label>[22a] HHDV b√°n ra kh√¥ng ch·ªãu thu·∫ø</label>
              <input type="number" [(ngModel)]="editingDeclaration.salesExempt"
                     (input)="calculateTotals()" min="0">
            </div>
            <div class="form-group col-span-2"></div>

            <div class="form-group col-span-2">
              <label>[23] HHDV b√°n ra ch·ªãu thu·∫ø su·∫•t 0%</label>
              <input type="number" [(ngModel)]="editingDeclaration.sales0"
                     (input)="calculateTotals()" min="0">
            </div>
            <div class="form-group col-span-2"></div>

            <div class="form-group col-span-2">
              <label>[24] HHDV b√°n ra ch·ªãu thu·∫ø su·∫•t 5%</label>
              <input type="number" [(ngModel)]="editingDeclaration.sales5"
                     (input)="calculateVat5()" min="0">
            </div>
            <div class="form-group col-span-2">
              <label>Thu·∫ø GTGT 5%</label>
              <input type="number" [(ngModel)]="editingDeclaration.vat5Output"
                     (input)="calculateTotals()" min="0">
            </div>

            <div class="form-group col-span-2">
              <label>[25] HHDV b√°n ra ch·ªãu thu·∫ø su·∫•t 8%</label>
              <input type="number" [(ngModel)]="editingDeclaration.sales8"
                     (input)="calculateVat8()" min="0">
            </div>
            <div class="form-group col-span-2">
              <label>Thu·∫ø GTGT 8%</label>
              <input type="number" [(ngModel)]="editingDeclaration.vat8Output"
                     (input)="calculateTotals()" min="0">
            </div>

            <div class="form-group col-span-2">
              <label>[26] HHDV b√°n ra ch·ªãu thu·∫ø su·∫•t 10%</label>
              <input type="number" [(ngModel)]="editingDeclaration.sales10"
                     (input)="calculateVat10()" min="0">
            </div>
            <div class="form-group col-span-2">
              <label>Thu·∫ø GTGT 10%</label>
              <input type="number" [(ngModel)]="editingDeclaration.vat10Output"
                     (input)="calculateTotals()" min="0">
            </div>
          </div>

          <div class="totals-row">
            <div class="total-item">
              <label>[27] T·ªïng doanh s·ªë b√°n ra:</label>
              <span class="total-value">{{ formatCurrency(editingDeclaration.totalSales) }}</span>
            </div>
            <div class="total-item">
              <label>[28] T·ªïng thu·∫ø GTGT ƒë·∫ßu ra:</label>
              <span class="total-value highlight">{{ formatCurrency(editingDeclaration.totalVatOutput) }}</span>
            </div>
          </div>
        </div>

        <!-- Input Section -->
        <div class="form-section">
          <h3 class="section-title">II. H√ÄNG H√ìA D·ªäCH V·ª§ MUA V√ÄO</h3>

          <div class="form-grid">
            <div class="form-group col-span-2">
              <label>[29a] Gi√° tr·ªã HHDV mua v√†o</label>
              <input type="number" [(ngModel)]="editingDeclaration.totalPurchases"
                     (input)="calculateTotals()" min="0">
            </div>
            <div class="form-group col-span-2">
              <label>[29b] Thu·∫ø GTGT mua v√†o</label>
              <input type="number" [(ngModel)]="editingDeclaration.totalVatInput"
                     (input)="calculateTotals()" min="0">
            </div>

            <div class="form-group col-span-2">
              <label>[30] Thu·∫ø GTGT ƒë∆∞·ª£c kh·∫•u tr·ª´ k·ª≥ tr∆∞·ªõc chuy·ªÉn sang</label>
              <input type="number" [(ngModel)]="editingDeclaration.vatCreditBroughtForward"
                     (input)="calculateTotals()" min="0">
            </div>
            <div class="form-group col-span-2"></div>
          </div>

          <div class="totals-row">
            <div class="total-item">
              <label>[31] T·ªïng thu·∫ø GTGT ƒë∆∞·ª£c kh·∫•u tr·ª´:</label>
              <span class="total-value">{{ formatCurrency(editingDeclaration.totalVatDeductible) }}</span>
            </div>
          </div>
        </div>

        <!-- Result Section -->
        <div class="form-section result-section">
          <h3 class="section-title">III. K·∫æT QU·∫¢</h3>

          <div class="result-box" [ngClass]="getVatResultClass(editingDeclaration.vatPayableOrCredit || 0)">
            <div class="result-item">
              <label>[32] Thu·∫ø GTGT c√≤n ph·∫£i n·ªôp (+) ho·∫∑c c√≤n ƒë∆∞·ª£c kh·∫•u tr·ª´ (-):</label>
              <span class="result-value">{{ formatCurrency(editingDeclaration.vatPayableOrCredit) }}</span>
            </div>
          </div>

          <div class="form-grid" *ngIf="(editingDeclaration.vatPayableOrCredit || 0) < 0">
            <div class="form-group col-span-2">
              <label>[33] Thu·∫ø GTGT ƒë·ªÅ ngh·ªã ho√†n</label>
              <input type="number" [(ngModel)]="editingDeclaration.vatRefundRequested"
                     (input)="calculateTotals()" min="0">
            </div>
            <div class="form-group col-span-2">
              <label>[34] Thu·∫ø GTGT c√≤n ƒë∆∞·ª£c kh·∫•u tr·ª´ chuy·ªÉn k·ª≥ sau</label>
              <input type="number" [value]="editingDeclaration.vatCreditCarryForward" disabled>
            </div>
          </div>
        </div>

        <!-- Note -->
        <div class="form-group">
          <label>Ghi ch√∫</label>
          <textarea [(ngModel)]="editingDeclaration.note" rows="2"></textarea>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeEditModal()">H·ªßy</button>
        <button class="btn btn-primary" (click)="saveDeclaration()" [disabled]="isSaving">
          {{ isSaving ? 'ƒêang l∆∞u...' : 'L∆∞u t·ªù khai' }}
        </button>
      </div>
    </div>
  </div>

  <!-- DETAIL MODAL -->
  <div class="modal-overlay" *ngIf="showDetailModal && selectedDeclaration" (click)="closeDetailModal()">
    <div class="modal modal-large" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Chi ti·∫øt T·ªù Khai GTGT - {{ formatPeriod(selectedDeclaration) }}</h2>
        <button class="btn-close" (click)="closeDetailModal()">√ó</button>
      </div>

      <div class="modal-body">
        <!-- Info -->
        <div class="detail-header">
          <div class="detail-info">
            <p><strong>S·ªë t·ªù khai:</strong> {{ selectedDeclaration.declarationNo }}</p>
            <p><strong>K·ª≥ k√™ khai:</strong> {{ formatPeriod(selectedDeclaration) }}</p>
            <p><strong>Tr·∫°ng th√°i:</strong>
              <span class="status-badge" [ngClass]="getStatusClass(selectedDeclaration.status)">
                {{ statusLabels[selectedDeclaration.status] }}
              </span>
            </p>
          </div>
          <div class="detail-info" *ngIf="selectedDeclaration.isAmendment">
            <span class="amendment-label">T·ªù khai b·ªï sung l·∫ßn {{ selectedDeclaration.amendmentNo }}</span>
          </div>
        </div>

        <!-- Output -->
        <div class="detail-section">
          <h4>I. H√ÄNG H√ìA D·ªäCH V·ª§ B√ÅN RA</h4>
          <table class="detail-table">
            <tr>
              <td>[22a] HHDV kh√¥ng ch·ªãu thu·∫ø:</td>
              <td class="text-right">{{ formatCurrency(selectedDeclaration.salesExempt) }}</td>
              <td></td>
              <td></td>
            </tr>
            <tr>
              <td>[23] HHDV ch·ªãu thu·∫ø 0%:</td>
              <td class="text-right">{{ formatCurrency(selectedDeclaration.sales0) }}</td>
              <td>Thu·∫ø:</td>
              <td class="text-right">0</td>
            </tr>
            <tr>
              <td>[24] HHDV ch·ªãu thu·∫ø 5%:</td>
              <td class="text-right">{{ formatCurrency(selectedDeclaration.sales5) }}</td>
              <td>Thu·∫ø:</td>
              <td class="text-right">{{ formatCurrency(selectedDeclaration.vat5Output) }}</td>
            </tr>
            <tr>
              <td>[25] HHDV ch·ªãu thu·∫ø 8%:</td>
              <td class="text-right">{{ formatCurrency(selectedDeclaration.sales8) }}</td>
              <td>Thu·∫ø:</td>
              <td class="text-right">{{ formatCurrency(selectedDeclaration.vat8Output) }}</td>
            </tr>
            <tr>
              <td>[26] HHDV ch·ªãu thu·∫ø 10%:</td>
              <td class="text-right">{{ formatCurrency(selectedDeclaration.sales10) }}</td>
              <td>Thu·∫ø:</td>
              <td class="text-right">{{ formatCurrency(selectedDeclaration.vat10Output) }}</td>
            </tr>
            <tr class="total-row">
              <td><strong>[27] T·ªïng doanh s·ªë:</strong></td>
              <td class="text-right"><strong>{{ formatCurrency(selectedDeclaration.totalSales) }}</strong></td>
              <td><strong>[28] T·ªïng thu·∫ø:</strong></td>
              <td class="text-right"><strong>{{ formatCurrency(selectedDeclaration.totalVatOutput) }}</strong></td>
            </tr>
          </table>
        </div>

        <!-- Input -->
        <div class="detail-section">
          <h4>II. H√ÄNG H√ìA D·ªäCH V·ª§ MUA V√ÄO</h4>
          <table class="detail-table">
            <tr>
              <td>[29a] Gi√° tr·ªã HHDV mua v√†o:</td>
              <td class="text-right">{{ formatCurrency(selectedDeclaration.totalPurchases) }}</td>
              <td>[29b] Thu·∫ø GTGT:</td>
              <td class="text-right">{{ formatCurrency(selectedDeclaration.totalVatInput) }}</td>
            </tr>
            <tr>
              <td>[30] Thu·∫ø kh·∫•u tr·ª´ k·ª≥ tr∆∞·ªõc chuy·ªÉn sang:</td>
              <td class="text-right">{{ formatCurrency(selectedDeclaration.vatCreditBroughtForward) }}</td>
              <td></td>
              <td></td>
            </tr>
            <tr class="total-row">
              <td colspan="2"><strong>[31] T·ªïng thu·∫ø ƒë∆∞·ª£c kh·∫•u tr·ª´:</strong></td>
              <td colspan="2" class="text-right"><strong>{{ formatCurrency(selectedDeclaration.totalVatDeductible) }}</strong></td>
            </tr>
          </table>
        </div>

        <!-- Result -->
        <div class="detail-section result-section">
          <h4>III. K·∫æT QU·∫¢</h4>
          <div class="result-display" [ngClass]="getVatResultClass(selectedDeclaration.vatPayableOrCredit)">
            <span class="result-label">[32] Thu·∫ø GTGT c√≤n ph·∫£i n·ªôp (+) / ƒë∆∞·ª£c kh·∫•u tr·ª´ (-):</span>
            <span class="result-amount">{{ formatCurrency(selectedDeclaration.vatPayableOrCredit) }} ‚Ç´</span>
            <span class="result-type" *ngIf="selectedDeclaration.vatPayableOrCredit > 0">Ph·∫£i n·ªôp</span>
            <span class="result-type" *ngIf="selectedDeclaration.vatPayableOrCredit < 0">ƒê∆∞·ª£c kh·∫•u tr·ª´</span>
          </div>

          <table class="detail-table" *ngIf="selectedDeclaration.vatPayableOrCredit < 0">
            <tr>
              <td>[33] Thu·∫ø ƒë·ªÅ ngh·ªã ho√†n:</td>
              <td class="text-right">{{ formatCurrency(selectedDeclaration.vatRefundRequested) }}</td>
            </tr>
            <tr>
              <td>[34] Thu·∫ø kh·∫•u tr·ª´ chuy·ªÉn k·ª≥ sau:</td>
              <td class="text-right">{{ formatCurrency(selectedDeclaration.vatCreditCarryForward) }}</td>
            </tr>
          </table>
        </div>

        <!-- Audit -->
        <div class="detail-audit">
          <p><strong>Ng√†y t·∫°o:</strong> {{ formatDate(selectedDeclaration.createdAt) }} - {{ selectedDeclaration.createdBy }}</p>
          <p *ngIf="selectedDeclaration.submittedAt">
            <strong>Ng√†y n·ªôp:</strong> {{ formatDate(selectedDeclaration.submittedAt) }} - {{ selectedDeclaration.submittedBy }}
          </p>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeDetailModal()">ƒê√≥ng</button>
        <button class="btn btn-secondary" (click)="createAmendment(selectedDeclaration)"
                *ngIf="selectedDeclaration.status === 'SUBMITTED'">
          T·∫°o t·ªù khai b·ªï sung
        </button>
        <button class="btn btn-primary" (click)="submitDeclaration(selectedDeclaration)"
                *ngIf="selectedDeclaration.status === 'DRAFT'">
          N·ªôp t·ªù khai
        </button>
      </div>
    </div>
  </div>

  <!-- LOADING -->
  <div class="loading-overlay" *ngIf="isLoading">
    <div class="spinner"></div>
  </div>
</div>

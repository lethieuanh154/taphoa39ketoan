<div class="salary-payment-page">
  <!-- HEADER -->
  <div class="page-header">
    <div class="header-left">
      <h1>üí≥ Thanh To√°n L∆∞∆°ng</h1>
      <p class="subtitle">N·ª£ TK 334 / C√≥ TK 111, 112</p>
    </div>
    <div class="header-actions">
      <select [(ngModel)]="filterYear" (change)="onYearChange()" class="year-select">
        <option *ngFor="let y of years" [value]="y">NƒÉm {{ y }}</option>
      </select>
      <button class="btn btn-primary" (click)="openCreateModal()">
        + T·∫°o phi·∫øu chi l∆∞∆°ng
      </button>
    </div>
  </div>

  <!-- SUMMARY CARDS -->
  <div class="summary-cards">
    <div class="card total-payments">
      <div class="card-icon">üìã</div>
      <div class="card-content">
        <span class="card-value">{{ payments.length }}</span>
        <span class="card-label">Phi·∫øu chi</span>
      </div>
    </div>
    <div class="card total-amount">
      <div class="card-icon">üí∞</div>
      <div class="card-content">
        <span class="card-value">{{ formatCurrency(getTotalPayments()) }}</span>
        <span class="card-label">T·ªïng chi l∆∞∆°ng</span>
      </div>
    </div>
    <div class="card cash-payment">
      <div class="card-icon">üíµ</div>
      <div class="card-content">
        <span class="card-value">{{ formatCurrency(getTotalCash()) }}</span>
        <span class="card-label">Ti·ªÅn m·∫∑t</span>
      </div>
    </div>
    <div class="card bank-payment">
      <div class="card-icon">üè¶</div>
      <div class="card-content">
        <span class="card-value">{{ formatCurrency(getTotalBank()) }}</span>
        <span class="card-label">Chuy·ªÉn kho·∫£n</span>
      </div>
    </div>
  </div>

  <!-- PAYMENT LIST -->
  <div class="payment-list">
    <div class="list-header">
      <h2>Danh s√°ch phi·∫øu chi l∆∞∆°ng nƒÉm {{ filterYear }}</h2>
    </div>

    <div class="table-container">
      <table class="data-table">
        <thead>
          <tr>
            <th class="col-no">S·ªë phi·∫øu</th>
            <th class="col-date">Ng√†y chi</th>
            <th class="col-payroll">B·∫£ng l∆∞∆°ng</th>
            <th class="col-count">S·ªë NV</th>
            <th class="col-amount">T·ªïng chi</th>
            <th class="col-method">PT chi</th>
            <th class="col-status">Tr·∫°ng th√°i</th>
            <th class="col-actions">Thao t√°c</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let payment of payments"
              [class.row-cancelled]="payment.status === 'CANCELLED'"
              (click)="viewPayment(payment)">
            <td class="col-no">
              <strong>{{ payment.paymentNo }}</strong>
            </td>
            <td class="col-date">{{ formatDate(payment.paymentDate) }}</td>
            <td class="col-payroll">
              {{ payment.payrollNo }} (T{{ payment.payrollMonth }}/{{ payment.payrollYear }})
            </td>
            <td class="col-count center">{{ payment.summary.employeeCount }}</td>
            <td class="col-amount amount highlight">{{ formatCurrency(payment.summary.totalPayment) }}</td>
            <td class="col-method">
              <span class="method-badge" [class]="payment.primaryMethod === 'CASH' ? 'method-cash' : 'method-bank'">
                {{ getMethodLabel(payment.primaryMethod) }}
              </span>
            </td>
            <td class="col-status">
              <span class="status-badge" [ngClass]="getStatusClass(payment.status)">
                {{ getStatusLabel(payment.status) }}
              </span>
            </td>
            <td class="col-actions" (click)="$event.stopPropagation()">
              <button class="btn-icon" title="Xem chi ti·∫øt" (click)="viewPayment(payment)">üëÅÔ∏è</button>
              <button class="btn-icon" title="X√≥a"
                      *ngIf="payment.status === 'DRAFT'"
                      (click)="deletePayment(payment.id)">üóëÔ∏è</button>
            </td>
          </tr>
          <tr *ngIf="payments.length === 0">
            <td colspan="8" class="empty-row">
              Ch∆∞a c√≥ phi·∫øu chi l∆∞∆°ng n√†o trong nƒÉm {{ filterYear }}
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- CREATE MODAL -->
  <div class="modal-overlay" *ngIf="showCreateModal" (click)="closeCreateModal()">
    <div class="modal create-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>T·∫°o phi·∫øu chi l∆∞∆°ng</h2>
        <button class="btn-close" (click)="closeCreateModal()">√ó</button>
      </div>

      <div class="modal-body">
        <!-- Select Payroll -->
        <div class="section">
          <h3>Ch·ªçn b·∫£ng l∆∞∆°ng ƒë√£ duy·ªát</h3>
          <div class="payroll-list-select">
            <div *ngFor="let payroll of payrolls"
                 class="payroll-item"
                 [class.selected]="selectedPayroll?.id === payroll.id"
                 (click)="selectPayroll(payroll)">
              <div class="payroll-info">
                <span class="payroll-no">{{ payroll.payrollNo }}</span>
                <span class="payroll-period">Th√°ng {{ payroll.month }}/{{ payroll.year }}</span>
              </div>
              <div class="payroll-amount">
                <span class="label">Th·ª±c lƒ©nh:</span>
                <span class="value">{{ formatCurrency(payroll.summary.totalNetSalary) }}</span>
              </div>
              <div class="payroll-count">
                {{ payroll.summary.employeeCount }} NV
              </div>
            </div>
            <div *ngIf="payrolls.length === 0" class="no-payroll">
              Kh√¥ng c√≥ b·∫£ng l∆∞∆°ng ƒë√£ duy·ªát
            </div>
          </div>
        </div>

        <!-- Payment Info -->
        <div class="section" *ngIf="selectedPayroll">
          <h3>Th√¥ng tin thanh to√°n</h3>
          <div class="form-row">
            <div class="form-group">
              <label>Ng√†y chi</label>
              <input type="date" [(ngModel)]="newPaymentDate">
            </div>
            <div class="form-group">
              <label>Ph∆∞∆°ng th·ª©c chi</label>
              <select [(ngModel)]="newPaymentMethod">
                <option *ngFor="let m of methods" [value]="m.value">{{ m.label }}</option>
              </select>
            </div>
          </div>

          <div class="form-group" *ngIf="newPaymentMethod === 'BANK_TRANSFER'">
            <label>T√†i kho·∫£n ng√¢n h√†ng</label>
            <select [(ngModel)]="newBankAccountId">
              <option *ngFor="let acc of bankAccounts" [value]="acc.id">
                {{ acc.bankName }} - {{ acc.accountNo }}
              </option>
            </select>
          </div>

          <div class="payment-summary">
            <div class="summary-row">
              <span>S·ªë nh√¢n vi√™n:</span>
              <strong>{{ selectedPayroll.summary.employeeCount }}</strong>
            </div>
            <div class="summary-row">
              <span>T·ªïng th·ª±c lƒ©nh:</span>
              <strong>{{ formatCurrency(selectedPayroll.summary.totalNetSalary) }}</strong>
            </div>
            <div class="summary-row">
              <span>ƒê√£ t·∫°m ·ª©ng:</span>
              <strong class="negative">-{{ formatCurrency(selectedPayroll.summary.totalOtherDeductions) }}</strong>
            </div>
            <div class="summary-row total">
              <span>S·ªë ti·ªÅn c·∫ßn chi:</span>
              <strong>{{ formatCurrency(selectedPayroll.summary.totalNetSalary - selectedPayroll.summary.totalOtherDeductions) }}</strong>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeCreateModal()">H·ªßy</button>
        <button class="btn btn-primary" (click)="createPayment()"
                [disabled]="!selectedPayroll">
          T·∫°o phi·∫øu chi
        </button>
      </div>
    </div>
  </div>

  <!-- DETAIL MODAL -->
  <div class="modal-overlay" *ngIf="showDetailModal" (click)="closeDetailModal()">
    <div class="modal detail-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div>
          <h2>{{ editingPayment?.paymentNo }}</h2>
          <span class="subtitle">Ng√†y chi: {{ formatDate(editingPayment?.paymentDate) }}</span>
          <span class="status-badge" [ngClass]="getStatusClass(editingPayment?.status || 'DRAFT')">
            {{ getStatusLabel(editingPayment?.status || 'DRAFT') }}
          </span>
        </div>
        <div class="header-actions">
          <button class="btn btn-secondary" (click)="print()">üñ®Ô∏è In</button>
          <button class="btn-close" (click)="closeDetailModal()">√ó</button>
        </div>
      </div>

      <div class="modal-body" *ngIf="editingPayment">
        <!-- Payment Info -->
        <div class="payment-info-grid">
          <div class="info-item">
            <span class="label">B·∫£ng l∆∞∆°ng:</span>
            <span class="value">{{ editingPayment.payrollNo }} (T{{ editingPayment.payrollMonth }}/{{ editingPayment.payrollYear }})</span>
          </div>
          <div class="info-item">
            <span class="label">Ph∆∞∆°ng th·ª©c:</span>
            <span class="value">{{ getMethodLabel(editingPayment.primaryMethod) }}</span>
          </div>
          <div class="info-item">
            <span class="label">ƒê·ªãnh kho·∫£n:</span>
            <span class="value">N·ª£ {{ editingPayment.debitAccount }} / C√≥ {{ editingPayment.creditAccount }}</span>
          </div>
          <div class="info-item highlight">
            <span class="label">T·ªïng chi:</span>
            <span class="value">{{ formatCurrency(editingPayment.summary.totalPayment) }} VNƒê</span>
          </div>
        </div>

        <!-- Detail Table -->
        <div class="detail-table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>STT</th>
                <th>M√£ NV</th>
                <th>H·ªç v√† t√™n</th>
                <th>Ph√≤ng ban</th>
                <th>Th·ª±c lƒ©nh</th>
                <th>T·∫°m ·ª©ng</th>
                <th>C√≤n tr·∫£</th>
                <th>S·ªë ti·ªÅn chi</th>
                <th>PT chi</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let line of editingPayment.lines; let i = index">
                <td class="center">{{ i + 1 }}</td>
                <td>{{ line.employeeCode }}</td>
                <td>{{ line.employeeName }}</td>
                <td>{{ line.department }}</td>
                <td class="amount">{{ formatCurrency(line.netSalary) }}</td>
                <td class="amount negative">{{ formatCurrency(line.advanceAmount) }}</td>
                <td class="amount">{{ formatCurrency(line.remainingAmount) }}</td>
                <td class="amount highlight">{{ formatCurrency(line.paymentAmount) }}</td>
                <td>
                  <span class="method-badge small" [class]="line.paymentMethod === 'CASH' ? 'method-cash' : 'method-bank'">
                    {{ getMethodLabel(line.paymentMethod) }}
                  </span>
                </td>
              </tr>
            </tbody>
            <tfoot>
              <tr class="total-row">
                <td colspan="4"><strong>T·ªîNG C·ªòNG</strong></td>
                <td class="amount"><strong>{{ formatCurrency(editingPayment.summary.totalNetSalary) }}</strong></td>
                <td class="amount negative"><strong>{{ formatCurrency(editingPayment.summary.totalAdvance) }}</strong></td>
                <td class="amount"><strong>{{ formatCurrency(editingPayment.summary.totalRemaining) }}</strong></td>
                <td class="amount highlight"><strong>{{ formatCurrency(editingPayment.summary.totalPayment) }}</strong></td>
                <td></td>
              </tr>
            </tfoot>
          </table>
        </div>

        <!-- Payment Split -->
        <div class="payment-split">
          <div class="split-item">
            <span class="icon">üíµ</span>
            <span class="label">Ti·ªÅn m·∫∑t:</span>
            <span class="value">{{ formatCurrency(editingPayment.summary.cashPayment) }}</span>
          </div>
          <div class="split-item">
            <span class="icon">üè¶</span>
            <span class="label">Chuy·ªÉn kho·∫£n:</span>
            <span class="value">{{ formatCurrency(editingPayment.summary.bankTransfer) }}</span>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <div class="footer-left">
          <span *ngIf="editingPayment?.approvedAt">
            Duy·ªát: {{ formatDate(editingPayment?.approvedAt) }} b·ªüi {{ editingPayment?.approvedBy }}
          </span>
          <span *ngIf="editingPayment?.paidAt">
            | Chi: {{ formatDate(editingPayment?.paidAt) }}
          </span>
        </div>
        <div class="footer-right">
          <button class="btn btn-secondary" (click)="closeDetailModal()">ƒê√≥ng</button>

          <ng-container *ngIf="editingPayment?.status === 'DRAFT'">
            <button class="btn btn-primary" (click)="savePayment()">üíæ L∆∞u</button>
            <button class="btn btn-success" (click)="approvePayment(editingPayment!.id)">‚úÖ Duy·ªát</button>
          </ng-container>

          <ng-container *ngIf="editingPayment?.status === 'APPROVED'">
            <button class="btn btn-success" (click)="markAsPaid(editingPayment!.id)">üí∞ X√°c nh·∫≠n ƒë√£ chi</button>
            <button class="btn btn-danger" (click)="cancelPayment(editingPayment!.id)">‚ùå H·ªßy</button>
          </ng-container>
        </div>
      </div>
    </div>
  </div>

  <!-- LOADING -->
  <div class="loading-overlay" *ngIf="isLoading">
    <div class="spinner"></div>
  </div>
</div>
